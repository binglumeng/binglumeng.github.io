<!DOCTYPE html>
<html lang="en">
<!-- Github Fork Tag -->
<a href="https://github.com/binglumeng"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/121cd7cbdc3e4855075ea8b558508b91ac463ac2/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_green_007200.png"></a>

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          Android图像与动画 - 冰路梦 | binglumeng
        
    </title>

    <link rel="canonical" href="https://binglumeng.github.io/2017/03/27/第四篇、Android图像与动画/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>

</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">冰路梦Github空间</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/about/">About Author</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="https://binglumeng.github.io/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#Android" title="Android">Android</a>
                        
                    </div>
                    <h1>Android图像与动画</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by 冰路梦 on
                        2017-03-27
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h2 id="第四篇、Android图像与动画"><a href="#第四篇、Android图像与动画" class="headerlink" title="第四篇、Android图像与动画"></a>第四篇、Android图像与动画</h2><p>[TOC]</p>
<h3 id="第1章、高效显示Bitmap"><a href="#第1章、高效显示Bitmap" class="headerlink" title="第1章、高效显示Bitmap"></a>第1章、高效显示Bitmap</h3><p>本节主要介绍加载处理Bitmap对象常用方法，以避免UI线程阻塞与OOM问题。由于Android设备</p>
<ul>
<li>Android单个应用至少16M内存，不同分辨率屏幕的设备要求不同。<code>国内自定义ROM限制也有差异。</code></li>
<li>Bitmap消耗内存，一张5M的高清照片，使用ARGB_8888方式加载Bitmap，则需要19M左右的内存。</li>
<li>Android应用一般加载多个Bitmap，预先加载以备显示。</li>
</ul>
<p>所以如上三条，需要我们对Bitmap做优化处理。</p>
<h4 id="1、高效加载大图（Loading-Large-Bitmap-Efficiently）"><a href="#1、高效加载大图（Loading-Large-Bitmap-Efficiently）" class="headerlink" title="1、高效加载大图（Loading Large Bitmap Efficiently）"></a>1、高效加载大图（Loading Large Bitmap Efficiently）</h4><p>本节介绍加载缩小的图片，来避免过多消耗内存，原始大小的图片和超过控件大小和设备分辨率的图片加载，在显示上并无意义，反而带来内存风险。</p>
<ul>
<li><h5 id="读取位图尺寸与类型（Read-Bitmap-Dimensions-and-Type）"><a href="#读取位图尺寸与类型（Read-Bitmap-Dimensions-and-Type）" class="headerlink" title="读取位图尺寸与类型（Read Bitmap Dimensions and Type）"></a>读取位图尺寸与类型（Read Bitmap Dimensions and Type）</h5><p><code>BitmapFactory</code>提供了不同类型的decode方法，配有<code>BitmapFactory.Options</code>选项来标记解码方式。</p>
<p>设置<code>inJustDecodeBounds=true</code>属性可以避免解码时候分配内存。其返回<code>null</code>的Bitmap，但是可以用于获取长宽和类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">BitmapFactory.Options options = <span class="keyword">new</span> BitmapFactory.Options();</div><div class="line">options.inJustDecodeBounds = <span class="keyword">true</span>;<span class="comment">//不加载分配内存</span></div><div class="line">BitmapFactory.decodeResource(getResource(),R.drawable.iclauncher,options);</div><div class="line"><span class="comment">//图像长宽</span></div><div class="line"><span class="keyword">int</span> imgWidth = options.outWidth;</div><div class="line"><span class="keyword">int</span> imgHeight = options.outHeight;</div><div class="line">String imgType = options.outMimeType;<span class="comment">//图像类型</span></div></pre></td></tr></table></figure>
<p><em>一般需要在加载图片前判断图片大小，避免OOM，除非你确保不会OOM</em></p>
</li>
<li><h5 id="加载缩小版图片到内存（Load-a-Scale-Down-Version-into-Memory）"><a href="#加载缩小版图片到内存（Load-a-Scale-Down-Version-into-Memory）" class="headerlink" title="加载缩小版图片到内存（Load a Scale Down Version into Memory）"></a>加载缩小版图片到内存（Load a Scale Down Version into Memory）</h5><p>加载缩小版图片也需要考虑一些因素：</p>
<ul>
<li>评估完整图片加载需耗内存。</li>
<li>加载图片可能涉及到的其他内存需求。</li>
<li>显示图片的控件尺寸。</li>
<li>设备屏幕的密度和大小。</li>
</ul>
<p>BitmapFactory.Options中设置<code>inSampleSize</code>来确定缩放比。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 计算图像缩放比</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">calculateInSampleSize</span><span class="params">(</span></span></div><div class="line">            BitmapFactory.Options options, <span class="keyword">int</span> reqWidth, <span class="keyword">int</span> reqHeight) &#123;</div><div class="line">    <span class="comment">// 获取图像的原始大小</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> height = options.outHeight;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> width = options.outWidth;</div><div class="line">    <span class="keyword">int</span> inSampleSize = <span class="number">1</span>;</div><div class="line">    <span class="keyword">if</span> (height &gt; reqHeight || width &gt; reqWidth) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> halfHeight = height / <span class="number">2</span>;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> halfWidth = width / <span class="number">2</span>;</div><div class="line">        <span class="comment">//保持宽高大于请求的宽高，缩放比为计算值的2倍</span></div><div class="line">        <span class="keyword">while</span> ((halfHeight / inSampleSize) &gt; reqHeight</div><div class="line">                &amp;&amp; (halfWidth / inSampleSize) &gt; reqWidth) &#123;</div><div class="line">            inSampleSize *= <span class="number">2</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> inSampleSize;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>==<em>设置缩放比<code>inSampleSize</code>为2的倍数，是因为解码器对非2倍数会就近处理为2的倍数。</em>==</p>
<p>先设置<code>inJustDecodeBounds=true</code>来设置<code>inSampleSize</code>之后在设置<code>inJustDecodeBounds=false</code>加载缩放后的Bitmap</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">mImageView.setImageBitmap(decodeSampleBitmapFromResource(getResource(),R.drawable.iclauncher,<span class="number">100</span>,<span class="number">100</span>));<span class="comment">//加载大小100长宽的图片</span></div><div class="line"><span class="comment">/*</span></div><div class="line"> * 根据控件大小，加载缩放图片</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">decodeSampleBitmapFromResource</span><span class="params">(Resource res,<span class="keyword">int</span> resId,<span class="keyword">int</span> reqWidth,<span class="keyword">int</span> reqHeight)</span></span>&#123;</div><div class="line">  <span class="comment">//先空加载图片，计算缩放比</span></div><div class="line">  <span class="keyword">final</span> BitmapFactory.Options options = <span class="keyword">new</span> BitmapFactory.Options();</div><div class="line">  options.inJustDecodeBounds = <span class="keyword">true</span>;</div><div class="line">  BitmapFactory.decodeResource(res,resId,options);</div><div class="line">  options.inSampleSize = calculateInSampleSize(options,reqWidth,reqHeight);</div><div class="line">  <span class="comment">//解码缩放后的图像</span></div><div class="line">  options.inJustDecodeBounds = <span class="keyword">false</span>;</div><div class="line">  returen BitmapFactory.decodeResource(res,resId,options);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="2、非UI线程处理Bitmap"><a href="#2、非UI线程处理Bitmap" class="headerlink" title="2、非UI线程处理Bitmap"></a>2、非UI线程处理Bitmap</h4><p>上一节仅仅介绍了如何缩放加载图像，若是获取网络图像或者其他储存设备，则应避免在UI线程执行加载操作，避免ANR。</p>
<ul>
<li><h5 id="使用AsyncTask（Use-a-AsyncTask）"><a href="#使用AsyncTask（Use-a-AsyncTask）" class="headerlink" title="使用AsyncTask（Use a AsyncTask）"></a>使用AsyncTask（Use a AsyncTask）</h5><p>AsyncTask是Android提供的一个封装好的后台线程操作方式，并可以实现前后台信息传递。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BitmapWorkerTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span></span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> WeakReference imageViewReference;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> data = <span class="number">0</span>;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">BitmapWorkerTask</span><span class="params">(ImageView imageView)</span></span>&#123;</div><div class="line">    <span class="comment">//使用弱引用，确保图像会被及时的GC回收。</span></div><div class="line">    imageViewReference = <span class="keyword">new</span> WeakReference(imageView);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//后台解码图片</span></div><div class="line">  <span class="meta">@override</span></div><div class="line">  <span class="function"><span class="keyword">protected</span> Bitmap <span class="title">doInBackground</span><span class="params">(Integer... params)</span></span>&#123;</div><div class="line">    data = params[<span class="number">0</span>];</div><div class="line">    <span class="keyword">return</span> decodeSampleBitmapFromResource(getResource(),data,<span class="number">100</span>,<span class="number">100</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//完成解码后，加载图像到控件显示</span></div><div class="line">  <span class="comment">//要判断引用对象是否还存在，控件是否存在等，避免空指针。</span></div><div class="line">  <span class="meta">@override</span></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(Bitmap bitmap)</span></span>&#123;</div><div class="line">    <span class="keyword">if</span>(imageViewReference !=<span class="keyword">null</span> &amp;&amp; bitmap !=<span class="keyword">null</span>)&#123;</div><div class="line">      <span class="keyword">final</span> ImageView imageView = imageViewReference.get();</div><div class="line">      <span class="keyword">if</span>(imageView!=<span class="keyword">null</span>)&#123;</div><div class="line">        imageView.setImageBitmap(bitmap);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//创建一个任务task，执行异步加载</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBitmap</span><span class="params">(<span class="keyword">int</span> resId,ImageView imageView)</span></span>&#123;</div><div class="line">  BitmapWorkerTask task = <span class="keyword">new</span> BitmapWorkerTask(imageView);</div><div class="line">  task.execute(resId);<span class="comment">//执行Task</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><h5 id="处理并发问题（Handle-Concurrency）"><a href="#处理并发问题（Handle-Concurrency）" class="headerlink" title="处理并发问题（Handle Concurrency）"></a>处理并发问题（Handle Concurrency）</h5><p>List View和Grid View控件显示多个位图结合AsyncTask使用时会产生并发问题。每个item都执行task的话，启动顺序，任务顺序都很难保持一致性。为此可以使用Image View来保存最近使用的AsyncTask引用，创建一个专用的<code>Drawable</code>子类来存储任务引用，如<code>BitmapDrawable</code>,并提供占位图像:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncDrawable</span> <span class="keyword">extends</span> <span class="title">BitmapDrawable</span></span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> WeakReference bitmapWorkerTaskReference;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">AsyncDrawable</span><span class="params">(Resource res,Bitmap bitmap,BitmapWorkerTask bitmapWorkerTask)</span></span>&#123;</div><div class="line">    <span class="keyword">super</span>(res,bitmap);</div><div class="line">    <span class="comment">//初始化弱引用对象</span></div><div class="line">    bitmapWorkerTaskReference = <span class="keyword">new</span> BitmapWorkerTaskReference(bitmapWorkerTask);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//对外公开task的引用。</span></div><div class="line">  <span class="function"><span class="keyword">public</span> BitmapWorkerTask <span class="title">getBitmapWorkerTask</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> bitmapWorkerTaskReference.get();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在执行BitmapWorkerTask之前需要创建AsyncDrawable并绑定到ImageView上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBitmap</span><span class="params">(<span class="keyword">int</span> resId,ImageView imageView)</span></span>&#123;</div><div class="line">  <span class="keyword">if</span>(cancelPotentialWork(resId,imageView))&#123;</div><div class="line">    <span class="keyword">final</span> BitmapWorkerTask task = <span class="keyword">new</span> BitmapWorkerTask(imageView);</div><div class="line">    <span class="keyword">final</span> AsyncDrawable asyncDrawable = <span class="keyword">new</span> 							   AsyncDrawable(getResource(),mPlaceHolderBitmap,task);</div><div class="line">    imageView.setImageDrawable(asyncDrawable);</div><div class="line">    task.execute(resId);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//该方法用于检测是否有已存在的任务在执行该Image View控件的请求。</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">cancelPotentialWork</span><span class="params">(<span class="keyword">int</span> data, ImageView imageView)</span> </span>&#123;</div><div class="line">	<span class="comment">//检索AsyncTask是否已经被分配到指定的ImageView控件。</span></div><div class="line">  <span class="keyword">final</span> BitmapWorkerTask bitmapWorkerTask = getBitmapWorkerTask(imageView);</div><div class="line">    <span class="keyword">if</span> (bitmapWorkerTask != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> bitmapData = bitmapWorkerTask.data;</div><div class="line">        <span class="keyword">if</span> (bitmapData == <span class="number">0</span> || bitmapData != data) &#123;</div><div class="line">            <span class="comment">//取消先前的任务</span></div><div class="line">            bitmapWorkerTask.cancel(<span class="keyword">true</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//同样的请求任务已经在执行</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//没有符合当下请求的任务绑定在ImageView控件上，或者之前的取消了。</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">//获取控件相关的task</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BitmapWorkerTask <span class="title">getBitmapWorkerTask</span><span class="params">(ImageView imageView)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (imageView != <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="keyword">final</span> Drawable drawable = imageView.getDrawable();</div><div class="line">       <span class="keyword">if</span> (drawable <span class="keyword">instanceof</span> AsyncDrawable) &#123;</div><div class="line">           <span class="keyword">final</span> AsyncDrawable asyncDrawable = (AsyncDrawable) drawable;</div><div class="line">         <span class="comment">//获取AsyncDrawable中定义的绑定task引用</span></div><div class="line">           <span class="keyword">return</span> asyncDrawable.getBitmapWorkerTask();</div><div class="line">       &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>完成异步task的绑定后，在<code>onPostExecute()</code>中更新view</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BitmapWorkerTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span> </span>&#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(Bitmap bitmap)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isCancelled()) &#123;</div><div class="line">            bitmap = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">		<span class="comment">//更新View前，判断资源和控件的非空</span></div><div class="line">        <span class="keyword">if</span> (imageViewReference != <span class="keyword">null</span> &amp;&amp; bitmap != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">final</span> ImageView imageView = imageViewReference.get();</div><div class="line">            <span class="keyword">final</span> BitmapWorkerTask bitmapWorkerTask =</div><div class="line">                    getBitmapWorkerTask(imageView);</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">this</span> == bitmapWorkerTask &amp;&amp; imageView != <span class="keyword">null</span>) &#123;</div><div class="line">                imageView.setImageBitmap(bitmap);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>应用与listView和GridView等，循环利用子视图的控件，只要在设置ImageView的地方调用loadBitmap方法即可。如GridView的<code>getView()</code>中。</p>
</li>
</ul>
<h4 id="3、缓存Bitmap"><a href="#3、缓存Bitmap" class="headerlink" title="3、缓存Bitmap"></a>3、缓存Bitmap</h4><p>在List View或GridView控件场景中，可能需要大量图片展示，而且存在图片复用现象，此时就需要用到缓存，以提高效能和用户体验。</p>
<ul>
<li><h5 id="使用内存缓存（Use-a-Memory-Cache）"><a href="#使用内存缓存（Use-a-Memory-Cache）" class="headerlink" title="使用内存缓存（Use a Memory Cache）"></a>使用内存缓存（Use a Memory Cache）</h5><p>使用内存缓存实现以<em>空间换时间</em>，提高速度。<code>LruCache</code>类用于缓存Bitmaps，其使用强引用<code>LinkedHashMap</code>保存最近引用对象，在缓存超出设置大小时候剔除最近最少使用的对象。</p>
<blockquote>
<p><strong>注意：</strong>以前多使用<code>软引用</code>或<code>弱引用</code>但是现在并不推荐，由于Android版本的GC频率增高，引用效率也大为降低。</p>
</blockquote>
<p>为LruCache设置合适的大小，考虑一下因素：</p>
<ul>
<li>应用剩余可用内存大小</li>
<li>同时显示图像数量，以及预加载图片数量</li>
<li>设备屏幕尺寸与密度</li>
<li>图像尺寸、类型</li>
<li>图像被访问的频率高低</li>
<li>显示图像的质量和数量的平衡</li>
</ul>
<p>以上因素都需要具体分析，如下创建一个Bitmap的LruCache的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> LruCache&lt;String, Bitmap&gt; mMemoryCache;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 获取应用VM最大可用内存</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> maxMemory = (<span class="keyword">int</span>) (Runtime.getRuntime().maxMemory() / <span class="number">1024</span>);</div><div class="line"></div><div class="line">    <span class="comment">// 使用可用内存的1/8来缓存</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> cacheSize = maxMemory / <span class="number">8</span>;</div><div class="line">	<span class="comment">//建立LruCache缓存对象</span></div><div class="line">    mMemoryCache = <span class="keyword">new</span> LruCache&lt;String, Bitmap&gt;(cacheSize) &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">sizeOf</span><span class="params">(String key, Bitmap bitmap)</span> </span>&#123;</div><div class="line">            <span class="comment">// 缓存以KB为单位计算，而非对象item个数</span></div><div class="line">            <span class="keyword">return</span> bitmap.getByteCount() / <span class="number">1024</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"><span class="comment">//加入bitmap对象到lrucache</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBitmapToMemoryCache</span><span class="params">(String key, Bitmap bitmap)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (getBitmapFromMemCache(key) == <span class="keyword">null</span>) &#123;</div><div class="line">        mMemoryCache.put(key, bitmap);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//从lrucache获取bitmap缓存</span></div><div class="line"><span class="function"><span class="keyword">public</span> Bitmap <span class="title">getBitmapFromMemCache</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> mMemoryCache.get(key);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong>在上面的例子中, 有1/8的内存空间被用作缓存。 这意味着在常见的设备上（hdpi），最少大概有4MB的缓存空间（32/8）。如果一个填满图片的GridView控件放置在800x480像素的手机屏幕上，大概会花费1.5MB的缓存空间（800x480x4 bytes），因此缓存的容量大概可以缓存2.5页的图片内容。</p>
</blockquote>
<p>加入缓存的bitmap亦是已经优化过的图像：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BitmapWorkerTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">Integer</span>, <span class="title">Void</span>, <span class="title">Bitmap</span>&gt; </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">//异步线程解码图像</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Bitmap <span class="title">doInBackground</span><span class="params">(Integer... params)</span> </span>&#123;</div><div class="line">      <span class="comment">//缩放图像</span></div><div class="line">        <span class="keyword">final</span> Bitmap bitmap = decodeSampledBitmapFromResource(</div><div class="line">                getResources(), params[<span class="number">0</span>], <span class="number">100</span>, <span class="number">100</span>));</div><div class="line">      <span class="comment">//添加到lrucache缓存</span></div><div class="line">        addBitmapToMemoryCache(String.valueOf(params[<span class="number">0</span>]), bitmap);</div><div class="line">        <span class="keyword">return</span> bitmap;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><h5 id="使用磁盘缓存（Use-a-Disk-Cache）"><a href="#使用磁盘缓存（Use-a-Disk-Cache）" class="headerlink" title="使用磁盘缓存（Use a Disk Cache）"></a>使用磁盘缓存（Use a Disk Cache）</h5><p>使用内存作为缓存虽然有较高的速度，但也可能因为应用被后台化，系统资源不足，亦或者过于大量的图像加载，而导致效果不佳，体验不好。因而可以使用磁盘缓存，需要异步处理，避免ANR。</p>
<blockquote>
<p><strong>Note:</strong>如果图像过于频繁访问，可以使用<code>ContentProvider</code>更为合适。</p>
</blockquote>
<p>如下示例<code>DiskLruCache</code>为Android源码基础上优化的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> DiskLruCache mDiskLruCache;<span class="comment">//DiskLruCache对象</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object mDiskCacheLock = <span class="keyword">new</span> Object();<span class="comment">//常量化同步锁</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mDiskCacheStarting = <span class="keyword">true</span>;<span class="comment">//是否开启缓存</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DISK_CACHE_SIZE = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">10</span>; <span class="comment">// 10MB</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DISK_CACHE_SUBDIR = <span class="string">"thumbnails"</span>;<span class="comment">//缓存文件夹</span></div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 初始化内存缓存</span></div><div class="line">    ...</div><div class="line">    <span class="comment">// 后台线程初始化磁盘缓存</span></div><div class="line">    File cacheDir = getDiskCacheDir(<span class="keyword">this</span>, DISK_CACHE_SUBDIR);<span class="comment">//从磁盘加载出缓存文件</span></div><div class="line">    <span class="keyword">new</span> InitDiskCacheTask().execute(cacheDir);<span class="comment">//异步开始加载到缓存文件</span></div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"><span class="comment">//内部类，初始化磁盘加载task</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">InitDiskCacheTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">File</span>, <span class="title">Void</span>, <span class="title">Void</span>&gt; </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Void <span class="title">doInBackground</span><span class="params">(File... params)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (mDiskCacheLock) &#123;<span class="comment">//同步锁</span></div><div class="line">            File cacheDir = params[<span class="number">0</span>];<span class="comment">//缓存文件</span></div><div class="line">            mDiskLruCache = DiskLruCache.open(cacheDir, DISK_CACHE_SIZE);</div><div class="line">            mDiskCacheStarting = <span class="keyword">false</span>; <span class="comment">//完成初始化磁盘加载</span></div><div class="line">            mDiskCacheLock.notifyAll(); <span class="comment">//唤起其他休眠线程</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//异步加载图片的task，</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BitmapWorkerTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">Integer</span>, <span class="title">Void</span>, <span class="title">Bitmap</span>&gt; </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 解码图像</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Bitmap <span class="title">doInBackground</span><span class="params">(Integer... params)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> String imageKey = String.valueOf(params[<span class="number">0</span>]);</div><div class="line"></div><div class="line">        <span class="comment">//后台线程检查磁盘缓存</span></div><div class="line">        Bitmap bitmap = getBitmapFromDiskCache(imageKey);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (bitmap == <span class="keyword">null</span>) &#123; <span class="comment">// 磁盘缓存没有所需图像</span></div><div class="line">            <span class="comment">// 正常途径加载</span></div><div class="line">            <span class="keyword">final</span> Bitmap bitmap = decodeSampledBitmapFromResource(</div><div class="line">                    getResources(), params[<span class="number">0</span>], <span class="number">100</span>, <span class="number">100</span>));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//并将优化后的图像加入磁盘缓存</span></div><div class="line">        addBitmapToCache(imageKey, bitmap);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> bitmap;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"><span class="comment">//加入磁盘缓存</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBitmapToCache</span><span class="params">(String key, Bitmap bitmap)</span> </span>&#123;</div><div class="line">    <span class="comment">// 先加入内存缓存</span></div><div class="line">    <span class="keyword">if</span> (getBitmapFromMemCache(key) == <span class="keyword">null</span>) &#123;</div><div class="line">        mMemoryCache.put(key, bitmap);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 然后加入到磁盘缓存</span></div><div class="line">    <span class="keyword">synchronized</span> (mDiskCacheLock) &#123;</div><div class="line">        <span class="keyword">if</span> (mDiskLruCache != <span class="keyword">null</span> &amp;&amp; mDiskLruCache.get(key) == <span class="keyword">null</span>) &#123;</div><div class="line">            mDiskLruCache.put(key, bitmap);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//从磁盘缓存获取图像</span></div><div class="line"><span class="function"><span class="keyword">public</span> Bitmap <span class="title">getBitmapFromDiskCache</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (mDiskCacheLock) &#123;<span class="comment">//同步获取锁</span></div><div class="line">        <span class="comment">// 等待后台线程获取磁盘缓存</span></div><div class="line">        <span class="keyword">while</span> (mDiskCacheStarting) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                mDiskCacheLock.wait();</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mDiskLruCache != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> mDiskLruCache.get(key);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 为特定的app创建唯一的子文件夹，优先使用外部sd卡，若没有，就使用内部sd卡</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> File <span class="title">getDiskCacheDir</span><span class="params">(Context context, String uniqueName)</span> </span>&#123;</div><div class="line">    <span class="comment">// 检查是否有外部存储，否则用内部存储</span></div><div class="line">    <span class="keyword">final</span> String cachePath =</div><div class="line">            Environment.MEDIA_MOUNTED.equals(Environment.getExternalStorageState()) ||</div><div class="line">                    !isExternalStorageRemovable() ? getExternalCacheDir(context).getPath() :</div><div class="line">                            context.getCacheDir().getPath();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> File(cachePath + File.separator + uniqueName);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><strong>注意：</strong>如上使用==同步锁==是为了防止在后台异步I/O操作时候，错误读取。</p>
</blockquote>
<p>内存缓存检查可以在UI线程操作，而磁盘缓存需要在后台线程。</p>
</li>
<li><h5 id="处理配置改变（Handle-Configuration-Changes）"><a href="#处理配置改变（Handle-Configuration-Changes）" class="headerlink" title="处理配置改变（Handle Configuration Changes）"></a>处理配置改变（Handle Configuration Changes）</h5><p>Android的配置信息发生变化，Activity可能会随之变化、销毁重建。平滑恢复原有图像，创造良好用户体验，<code>setRetainInstance(true)</code>保留的一个<code>Fragement</code>实例可以将缓存重新附着与Activity上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> LruCache&lt;String, Bitmap&gt; mMemoryCache;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">      <span class="comment">//RetainFragment</span></div><div class="line">    RetainFragment retainFragment =</div><div class="line">            RetainFragment.findOrCreateRetainFragment(getFragmentManager());</div><div class="line">  <span class="comment">//获取缓存对象  </span></div><div class="line">  mMemoryCache = retainFragment.mRetainedCache;</div><div class="line">    <span class="keyword">if</span> (mMemoryCache == <span class="keyword">null</span>) &#123;</div><div class="line">        mMemoryCache = <span class="keyword">new</span> LruCache&lt;String, Bitmap&gt;(cacheSize) &#123;</div><div class="line">            ... <span class="comment">// 初始化缓存</span></div><div class="line">        &#125;</div><div class="line">        retainFragment.mRetainedCache = mMemoryCache;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"><span class="comment">//自定义内部类Fragment，用于存储缓存对象？？</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RetainFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"RetainFragment"</span>;</div><div class="line">    <span class="keyword">public</span> LruCache&lt;String, Bitmap&gt; mRetainedCache;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RetainFragment</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RetainFragment <span class="title">findOrCreateRetainFragment</span><span class="params">(FragmentManager fm)</span> </span>&#123;</div><div class="line">        RetainFragment fragment = (RetainFragment) fm.findFragmentByTag(TAG);</div><div class="line">        <span class="keyword">if</span> (fragment == <span class="keyword">null</span>) &#123;</div><div class="line">            fragment = <span class="keyword">new</span> RetainFragment();</div><div class="line">            fm.beginTransaction().add(fragment, TAG).commit();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> fragment;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setRetainInstance(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="4、管理Bitmap的内存"><a href="#4、管理Bitmap的内存" class="headerlink" title="4、管理Bitmap的内存"></a>4、管理Bitmap的内存</h4><p>关于Bitmap内存管理了解两点：1、Android2.3之后GC回收并发执行，内存不引用，会被立即回收。2、Android3.0以后bitmap引用和数据一同存放在<code>Dalvik堆</code>内存中。</p>
<ul>
<li><h5 id="Android2-3以下版本的内存管理"><a href="#Android2-3以下版本的内存管理" class="headerlink" title="Android2.3以下版本的内存管理"></a>Android2.3以下版本的内存管理</h5><p>推荐使用<code>recycle()</code>方法，低版本Android单线程GC。使用引用计数法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> mCacheRefCount=<span class="number">0</span>;<span class="comment">//引用计数</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> mDisplayRefCount = <span class="number">0</span>;<span class="comment">//引用计数</span></div><div class="line">...</div><div class="line"><span class="comment">//通知drawable显示状态发生改变，drawable引用计数来决定引用状态和显示</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIsDisplayed</span><span class="params">(<span class="keyword">boolean</span> isDisplayed)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (isDisplayed) &#123;</div><div class="line">            mDisplayRefCount++;</div><div class="line">            mHasBeenDisplayed = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mDisplayRefCount--;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Check to see if recycle() can be called.</span></div><div class="line">    checkState();</div><div class="line">&#125;</div><div class="line"><span class="comment">// Notify the drawable that the cache state has changed.</span></div><div class="line"><span class="comment">// Keep a count to determine when the drawable is no longer being cached.</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIsCached</span><span class="params">(<span class="keyword">boolean</span> isCached)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (isCached) &#123;</div><div class="line">            mCacheRefCount++;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mCacheRefCount--;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Check to see if recycle() can be called.</span></div><div class="line">    checkState();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">checkState</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// If the drawable cache and display ref counts = 0, and this drawable</span></div><div class="line">    <span class="comment">// has been displayed, then recycle.</span></div><div class="line">    <span class="keyword">if</span> (mCacheRefCount &lt;= <span class="number">0</span> &amp;&amp; mDisplayRefCount &lt;= <span class="number">0</span> &amp;&amp; mHasBeenDisplayed</div><div class="line">            &amp;&amp; hasValidBitmap()) &#123;</div><div class="line">        getBitmap().recycle();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">hasValidBitmap</span><span class="params">()</span> </span>&#123;</div><div class="line">    Bitmap bitmap = getBitmap();</div><div class="line">    <span class="keyword">return</span> bitmap != <span class="keyword">null</span> &amp;&amp; !bitmap.isRecycled();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><h5 id="Android3-0以上版本内存管理"><a href="#Android3-0以上版本内存管理" class="headerlink" title="Android3.0以上版本内存管理"></a>Android3.0以上版本内存管理</h5><p>API 11引入<code>BitmapFactory.Options.inBitmap</code>使Bitmap在加载时候可以重中已存在的，但是大小一样的位图（&lt; API 19时候）。</p>
</li>
<li><p>保存Bitmap以备复用</p>
<p>android3.0以上，bitmap从L如Cache移除时，Bitmap的软引用会被村房子啊Hashset中，以便<code>inBitmap</code>复用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">Set&lt;SoftReference&lt;Bitmap&gt;&gt; mReusableBitmaps;</div><div class="line"><span class="keyword">private</span> LruCache&lt;String, BitmapDrawable&gt; mMemoryCache;</div><div class="line"></div><div class="line"><span class="comment">// If you're running on Honeycomb or newer, create a</span></div><div class="line"><span class="comment">// synchronized HashSet of references to reusable bitmaps.</span></div><div class="line"><span class="keyword">if</span> (Utils.hasHoneycomb()) &#123;</div><div class="line">    mReusableBitmaps =</div><div class="line">            Collections.synchronizedSet(<span class="keyword">new</span> HashSet&lt;SoftReference&lt;Bitmap&gt;&gt;());</div><div class="line">&#125;</div><div class="line"></div><div class="line">mMemoryCache = <span class="keyword">new</span> LruCache&lt;String, BitmapDrawable&gt;(mCacheParams.memCacheSize) &#123;</div><div class="line"></div><div class="line">    <span class="comment">// Notify the removed entry that is no longer being cached.</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">entryRemoved</span><span class="params">(<span class="keyword">boolean</span> evicted, String key,</span></span></div><div class="line">            BitmapDrawable oldValue, BitmapDrawable newValue) &#123;</div><div class="line">        <span class="keyword">if</span> (RecyclingBitmapDrawable.class.isInstance(oldValue)) &#123;</div><div class="line">            <span class="comment">// The removed entry is a recycling drawable, so notify it</span></div><div class="line">            <span class="comment">// that it has been removed from the memory cache.</span></div><div class="line">            ((RecyclingBitmapDrawable) oldValue).setIsCached(<span class="keyword">false</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// The removed entry is a standard BitmapDrawable.</span></div><div class="line">            <span class="keyword">if</span> (Utils.hasHoneycomb()) &#123;</div><div class="line">                <span class="comment">// We're running on Honeycomb or later, so add the bitmap</span></div><div class="line">                <span class="comment">// to a SoftReference set for possible use with inBitmap later.</span></div><div class="line">                mReusableBitmaps.add</div><div class="line">                        (<span class="keyword">new</span> SoftReference&lt;Bitmap&gt;(oldValue.getBitmap()));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">....</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><h5 id="使用已经存在的Bitmap"><a href="#使用已经存在的Bitmap" class="headerlink" title="使用已经存在的Bitmap"></a>使用已经存在的Bitmap</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">decodeSampledBitmapFromFile</span><span class="params">(String filename,</span></span></div><div class="line">        <span class="keyword">int</span> reqWidth, <span class="keyword">int</span> reqHeight, ImageCache cache) &#123;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> BitmapFactory.Options options = <span class="keyword">new</span> BitmapFactory.Options();</div><div class="line">    ...</div><div class="line">    BitmapFactory.decodeFile(filename, options);</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="comment">// If we're running on Honeycomb or newer, try to use inBitmap.</span></div><div class="line">    <span class="keyword">if</span> (Utils.hasHoneycomb()) &#123;</div><div class="line">        addInBitmapOptions(options, cache);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> BitmapFactory.decodeFile(filename, options);</div><div class="line">&#125;</div><div class="line"><span class="comment">//查找适合且可复用的bitmap，设置到inBitmap的属性值，</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addInBitmapOptions</span><span class="params">(BitmapFactory.Options options,</span></span></div><div class="line">        ImageCache cache) &#123;</div><div class="line">    <span class="comment">// inBitmap only works with mutable bitmaps, so force the decoder to</span></div><div class="line">    <span class="comment">// return mutable bitmaps.</span></div><div class="line">    options.inMutable = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (cache != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// Try to find a bitmap to use for inBitmap.</span></div><div class="line">        Bitmap inBitmap = cache.getBitmapFromReusableSet(options);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (inBitmap != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// If a suitable bitmap has been found, set it as the value of</span></div><div class="line">            <span class="comment">// inBitmap.</span></div><div class="line">            options.inBitmap = inBitmap;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// This method iterates through the reusable bitmaps, looking for one</span></div><div class="line"><span class="comment">// to use for inBitmap:</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Bitmap <span class="title">getBitmapFromReusableSet</span><span class="params">(BitmapFactory.Options options)</span> </span>&#123;</div><div class="line">        Bitmap bitmap = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mReusableBitmaps != <span class="keyword">null</span> &amp;&amp; !mReusableBitmaps.isEmpty()) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (mReusableBitmaps) &#123;</div><div class="line">            <span class="keyword">final</span> Iterator&lt;SoftReference&lt;Bitmap&gt;&gt; iterator</div><div class="line">                    = mReusableBitmaps.iterator();</div><div class="line">            Bitmap item;</div><div class="line"></div><div class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</div><div class="line">                item = iterator.next().get();</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != item &amp;&amp; item.isMutable()) &#123;</div><div class="line">                    <span class="comment">// Check to see it the item can be used for inBitmap.</span></div><div class="line">                    <span class="keyword">if</span> (canUseForInBitmap(item, options)) &#123;</div><div class="line">                        bitmap = item;</div><div class="line"></div><div class="line">                        <span class="comment">// Remove from reusable set so it can't be used again.</span></div><div class="line">                        iterator.remove();</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// Remove from the set if the reference has been cleared.</span></div><div class="line">                    iterator.remove();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> bitmap;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>判断Bitmap是否符合inBitmap的要求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">canUseForInBitmap</span><span class="params">(</span></span></div><div class="line">        Bitmap candidate, BitmapFactory.Options targetOptions) &#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</div><div class="line">        <span class="comment">// From Android 4.4 (KitKat) onward we can re-use if the byte size of</span></div><div class="line">        <span class="comment">// the new bitmap is smaller than the reusable bitmap candidate</span></div><div class="line">        <span class="comment">// allocation byte count.</span></div><div class="line">        <span class="keyword">int</span> width = targetOptions.outWidth / targetOptions.inSampleSize;</div><div class="line">        <span class="keyword">int</span> height = targetOptions.outHeight / targetOptions.inSampleSize;</div><div class="line">        <span class="keyword">int</span> byteCount = width * height * getBytesPerPixel(candidate.getConfig());</div><div class="line">        <span class="keyword">return</span> byteCount &lt;= candidate.getAllocationByteCount();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// On earlier versions, the dimensions must match exactly and the inSampleSize must be 1</span></div><div class="line">    <span class="keyword">return</span> candidate.getWidth() == targetOptions.outWidth</div><div class="line">            &amp;&amp; candidate.getHeight() == targetOptions.outHeight</div><div class="line">            &amp;&amp; targetOptions.inSampleSize == <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * A helper function to return the byte usage per pixel of a bitmap based on its configuration.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getBytesPerPixel</span><span class="params">(Config config)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (config == Config.ARGB_8888) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">4</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config == Config.RGB_565) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">2</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config == Config.ARGB_4444) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">2</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config == Config.ALPHA_8) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="5、在UI上显示Bitmap"><a href="#5、在UI上显示Bitmap" class="headerlink" title="5、在UI上显示Bitmap"></a>5、在UI上显示Bitmap</h4><p>本节学习如何综合使用后台线程与缓存机制，将图像加载到ViewPager或Grid View控件上，并处理并发与配置改变的问题。</p>
<ul>
<li><h5 id="实现加载图片到View-Pager"><a href="#实现加载图片到View-Pager" class="headerlink" title="实现加载图片到View Pager"></a>实现加载图片到View Pager</h5><p><code>Swipe View Pattern</code>是滑动显示的设计模型。可通过<code>PagerAdapter</code>与<code>ViewPager</code>控件实现该效果。而<code>FragmentStatePagerAdapter</code>更为合适，因为其能在Fragment状态改变时保存状态值。减少内存消耗。少量图片的话，<code>PagerAdapter与FragmentPagerAdapter</code>都可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageDetailActivity</span> <span class="keyword">extends</span> <span class="title">FragmentActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXTRA_IMAGE = <span class="string">"extra_image"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ImagePagerAdapter mAdapter;<span class="comment">//adapter</span></div><div class="line">    <span class="keyword">private</span> ViewPager mPager;<span class="comment">//viewpager</span></div><div class="line"></div><div class="line">    <span class="comment">// 用于传递给viewpager 的adapter的图片数据资源</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> Integer[] imageResIds = <span class="keyword">new</span> Integer[] &#123;</div><div class="line">            R.drawable.sample_image_1, R.drawable.sample_image_2, R.drawable.sample_image_3,</div><div class="line">            R.drawable.sample_image_4, R.drawable.sample_image_5, R.drawable.sample_image_6,</div><div class="line">            R.drawable.sample_image_7, R.drawable.sample_image_8, R.drawable.sample_image_9&#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.image_detail_pager); <span class="comment">// 就一个viewpager</span></div><div class="line">		<span class="comment">//初始化控件，并绑定适配器</span></div><div class="line">        mAdapter = <span class="keyword">new</span> ImagePagerAdapter(getSupportFragmentManager(), imageResIds.length);</div><div class="line">        mPager = (ViewPager) findViewById(R.id.pager);</div><div class="line">        mPager.setAdapter(mAdapter);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ImagePagerAdapter</span> <span class="keyword">extends</span> <span class="title">FragmentStatePagerAdapter</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mSize;</div><div class="line">		<span class="comment">//</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ImagePagerAdapter</span><span class="params">(FragmentManager fm, <span class="keyword">int</span> size)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(fm);</div><div class="line">            mSize = size;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> mSize;</div><div class="line">        &#125;</div><div class="line">		<span class="comment">//返回fragment对象</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Fragment <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> ImageDetailFragment.newInstance(position);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Fragment里面包含Image View控件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageDetailFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String IMAGE_DATA_EXTRA = <span class="string">"resId"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mImageNum;<span class="comment">//图像数目</span></div><div class="line">    <span class="keyword">private</span> ImageView mImageView;<span class="comment">//image view控件</span></div><div class="line">	<span class="comment">//构造函数，接收图片数目参数</span></div><div class="line">    <span class="function"><span class="keyword">static</span> ImageDetailFragment <span class="title">newInstance</span><span class="params">(<span class="keyword">int</span> imageNum)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> ImageDetailFragment f = <span class="keyword">new</span> ImageDetailFragment();</div><div class="line">        <span class="keyword">final</span> Bundle args = <span class="keyword">new</span> Bundle();</div><div class="line">        args.putInt(IMAGE_DATA_EXTRA, imageNum);</div><div class="line">        f.setArguments(args);</div><div class="line">        <span class="keyword">return</span> f;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Empty constructor, required as per Fragment docs</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ImageDetailFragment</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        mImageNum = getArguments() != <span class="keyword">null</span> ? getArguments().getInt(IMAGE_DATA_EXTRA) : -<span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container,</span></span></div><div class="line">            Bundle savedInstanceState) &#123;</div><div class="line">        <span class="comment">// image_detail_fragment.xml contains just an ImageView</span></div><div class="line">        <span class="keyword">final</span> View v = inflater.inflate(R.layout.image_detail_fragment, container, <span class="keyword">false</span>);</div><div class="line">        mImageView = (ImageView) v.findViewById(R.id.imageView);</div><div class="line">        <span class="keyword">return</span> v;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> resId = ImageDetailActivity.imageResIds[mImageNum];</div><div class="line">        mImageView.setImageResource(resId); <span class="comment">// Load image into ImageView</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>==<strong>如上方式，可能会阻塞UI线程</strong>==，改用AsyncTask最好：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageDetailActivity</span> <span class="keyword">extends</span> <span class="title">FragmentActivity</span> </span>&#123;</div><div class="line">    ...</div><div class="line">	<span class="comment">//后台加载图片</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBitmap</span><span class="params">(<span class="keyword">int</span> resId, ImageView imageView)</span> </span>&#123;</div><div class="line">        mImageView.setImageResource(R.drawable.image_placeholder);</div><div class="line">      <span class="comment">//后台执行</span></div><div class="line">        BitmapWorkerTask task = <span class="keyword">new</span> BitmapWorkerTask(mImageView);</div><div class="line">        task.execute(resId);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ... <span class="comment">// include BitmapWorkerTask class</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageDetailFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</div><div class="line">        <span class="keyword">if</span> (ImageDetailActivity.class.isInstance(getActivity())) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> resId = ImageDetailActivity.imageResIds[mImageNum];</div><div class="line">            <span class="comment">//调用上面的后台加载图片</span></div><div class="line">            ((ImageDetailActivity) getActivity()).loadBitmap(resId, mImageView);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>后台的操作可以更为合理，加载并缓存图像</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageDetailActivity</span> <span class="keyword">extends</span> <span class="title">FragmentActivity</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">private</span> LruCache mMemoryCache;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        ...</div><div class="line">        <span class="comment">// initialize LruCache as per Use a Memory Cache section</span></div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBitmap</span><span class="params">(<span class="keyword">int</span> resId, ImageView imageView)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> String imageKey = String.valueOf(resId);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Bitmap bitmap = mMemoryCache.get(imageKey);</div><div class="line">        <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</div><div class="line">            mImageView.setImageBitmap(bitmap);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mImageView.setImageResource(R.drawable.image_placeholder);</div><div class="line">            BitmapWorkerTask task = <span class="keyword">new</span> BitmapWorkerTask(mImageView);</div><div class="line">            task.execute(resId);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ... <span class="comment">// include updated BitmapWorkerTask from Use a Memory Cache section</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><h5 id="实现加载图片到GridView"><a href="#实现加载图片到GridView" class="headerlink" title="实现加载图片到GridView"></a>实现加载图片到GridView</h5><p>如下场景，Fragment内置Grid View，item是Image View：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageGridFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> <span class="keyword">implements</span> <span class="title">AdapterView</span>.<span class="title">OnItemClickListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> ImageAdapter mAdapter;</div><div class="line"></div><div class="line">    <span class="comment">//静态加载的图片资源，用于适配器</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> Integer[] imageResIds = <span class="keyword">new</span> Integer[] &#123;</div><div class="line">            R.drawable.sample_image_1, R.drawable.sample_image_2, R.drawable.sample_image_3,</div><div class="line">            R.drawable.sample_image_4, R.drawable.sample_image_5, R.drawable.sample_image_6,</div><div class="line">            R.drawable.sample_image_7, R.drawable.sample_image_8, R.drawable.sample_image_9&#125;;</div><div class="line"></div><div class="line">    <span class="comment">// Empty constructor as per Fragment docs</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ImageGridFragment</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        mAdapter = <span class="keyword">new</span> ImageAdapter(getActivity());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(</span></span></div><div class="line">            LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) &#123;</div><div class="line">      <span class="comment">//初始化控件，并绑定适配器，注册监听  </span></div><div class="line">      <span class="keyword">final</span> View v = inflater.inflate(R.layout.image_grid_fragment, container, <span class="keyword">false</span>);</div><div class="line">        <span class="keyword">final</span> GridView mGridView = (GridView) v.findViewById(R.id.gridView);</div><div class="line">        mGridView.setAdapter(mAdapter);</div><div class="line">        mGridView.setOnItemClickListener(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">return</span> v;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(AdapterView parent, View v, <span class="keyword">int</span> position, <span class="keyword">long</span> id)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Intent i = <span class="keyword">new</span> Intent(getActivity(), ImageDetailActivity.class);</div><div class="line">        i.putExtra(ImageDetailActivity.EXTRA_IMAGE, position);</div><div class="line">        startActivity(i);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageAdapter</span> <span class="keyword">extends</span> <span class="title">BaseAdapter</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Context mContext;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ImageAdapter</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>();</div><div class="line">            mContext = context;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> imageResIds.length;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> imageResIds[position];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getItemId</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> position;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup container)</span> </span>&#123;</div><div class="line">            ImageView imageView;</div><div class="line">            <span class="keyword">if</span> (convertView == <span class="keyword">null</span>) &#123; <span class="comment">// 判断是否是循环复用的item view，不是的话，需要初始化一些属性。</span></div><div class="line">                imageView = <span class="keyword">new</span> ImageView(mContext);</div><div class="line">                imageView.setScaleType(ImageView.ScaleType.CENTER_CROP);</div><div class="line">                imageView.setLayoutParams(<span class="keyword">new</span> GridView.LayoutParams(</div><div class="line">                        LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT));</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                imageView = (ImageView) convertView;</div><div class="line">            &#125;</div><div class="line">        <span class="comment">//请注意下面的代码，如此可能会耗时，阻塞UI</span></div><div class="line">        imageView.setImageResource(imageResIds[position]); <span class="comment">// Load image into ImageView</span></div><div class="line">        <span class="keyword">return</span> imageView;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>考虑UI的可能阻塞，以及GridView引起的并发问题，代码优化如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageGridFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> <span class="keyword">implements</span> <span class="title">AdapterView</span>.<span class="title">OnItemClickListener</span> </span>&#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageAdapter</span> <span class="keyword">extends</span> <span class="title">BaseAdapter</span> </span>&#123;</div><div class="line">        ...</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup container)</span> </span>&#123;</div><div class="line">            ...</div><div class="line">            loadBitmap(imageResIds[position], imageView)</div><div class="line">            <span class="keyword">return</span> imageView;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//异步加载图像</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBitmap</span><span class="params">(<span class="keyword">int</span> resId, ImageView imageView)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (cancelPotentialWork(resId, imageView)) &#123;</div><div class="line">            <span class="keyword">final</span> BitmapWorkerTask task = <span class="keyword">new</span> BitmapWorkerTask(imageView);</div><div class="line">            <span class="keyword">final</span> AsyncDrawable asyncDrawable =</div><div class="line">                    <span class="keyword">new</span> AsyncDrawable(getResources(), mPlaceHolderBitmap, task);</div><div class="line">            imageView.setImageDrawable(asyncDrawable);</div><div class="line">            task.execute(resId);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//用于绑定到imageView的drawable</span></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncDrawable</span> <span class="keyword">extends</span> <span class="title">BitmapDrawable</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> WeakReference bitmapWorkerTaskReference;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AsyncDrawable</span><span class="params">(Resources res, Bitmap bitmap,</span></span></div><div class="line">                BitmapWorkerTask bitmapWorkerTask) &#123;</div><div class="line">            <span class="keyword">super</span>(res, bitmap);</div><div class="line">            bitmapWorkerTaskReference =</div><div class="line">                <span class="keyword">new</span> WeakReference(bitmapWorkerTask);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> BitmapWorkerTask <span class="title">getBitmapWorkerTask</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> bitmapWorkerTaskReference.get();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//判断imageview是否已经有加载图像的task</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">cancelPotentialWork</span><span class="params">(<span class="keyword">int</span> data, ImageView imageView)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> BitmapWorkerTask bitmapWorkerTask = getBitmapWorkerTask(imageView);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (bitmapWorkerTask != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> bitmapData = bitmapWorkerTask.data;</div><div class="line">            <span class="keyword">if</span> (bitmapData != data) &#123;</div><div class="line">                <span class="comment">// Cancel previous task</span></div><div class="line">                bitmapWorkerTask.cancel(<span class="keyword">true</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// The same work is already in progress</span></div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// No task associated with the ImageView, or an existing task was cancelled</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//获取图像加载task</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BitmapWorkerTask <span class="title">getBitmapWorkerTask</span><span class="params">(ImageView imageView)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (imageView != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">final</span> Drawable drawable = imageView.getDrawable();</div><div class="line">           <span class="keyword">if</span> (drawable <span class="keyword">instanceof</span> AsyncDrawable) &#123;</div><div class="line">               <span class="keyword">final</span> AsyncDrawable asyncDrawable = (AsyncDrawable) drawable;</div><div class="line">               <span class="keyword">return</span> asyncDrawable.getBitmapWorkerTask();</div><div class="line">           &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ... <span class="comment">// include updated BitmapWorkerTask class</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="2、使用OpenGL-ES显示图像"><a href="#2、使用OpenGL-ES显示图像" class="headerlink" title="2、使用OpenGL ES显示图像"></a>2、使用OpenGL ES显示图像</h3><p>Android平台提供了OpenGL ES接口，帮助我们实现更为丰富的图像显示效果。本章记述OpenGL构建应用的基础知识，包括配置、绘制对象、移动图形以及响应事件。</p>
<p><strong>注意，不要混用OpenGL ES 1.x版和2.x版本的接口，因为并不通用。</strong></p>
<h4 id="1、建立OpenGL-ES的环境"><a href="#1、建立OpenGL-ES的环境" class="headerlink" title="1、建立OpenGL ES的环境"></a>1、建立OpenGL ES的环境</h4><p>在应用中使用OpenGL ES来绘制图像，需要给它一个容器。通常实现<code>GLSurfaceView</code>做容器和<code>GLSurfaceView.Renderer</code>类来控制绘制。<code>GLSurfaceView</code>一般用于全屏或者接近全屏的View绘制，若是小范围，可以用<code>TextureView</code>。亦或者自定义View继承SurfaceView，但是会费事。</p>
<ul>
<li><h5 id="在Manifest中声明使用OpenGL-ES"><a href="#在Manifest中声明使用OpenGL-ES" class="headerlink" title="在Manifest中声明使用OpenGL ES"></a>在Manifest中声明使用OpenGL ES</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">uses-feature</span> <span class="attr">android.glEsVersion</span>=<span class="string">"0x00020000"</span> <span class="attr">android.required</span>=<span class="string">"true"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>如果使用图像纹理压缩，则必须在清单中声明支持的压缩格式：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">supports-gl-texture</span> <span class="attr">android:name</span>=<span class="string">"GL_OES_compressed_ETC1_RGB8_texture"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">supports-gl-texture</span> <span class="attr">android:name</span>=<span class="string">"GL_OES_compressed_paletted_texture"</span>/&gt;</span></div><div class="line">...</div></pre></td></tr></table></figure>
<p>使用OpenGL ES的App可以Activity中使用GLSurfaceView布局。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//要求api&gt;=8</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenGLES20Activity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> GLSurfaceView mGLView;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">		<span class="comment">//创建GLSurfaceView对象，设置为Activity布局。</span></div><div class="line">        mGLView = <span class="keyword">new</span> MyGLSurfaceView(<span class="keyword">this</span>);</div><div class="line">        setContentView(mGLView);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><h5 id="构建一个GLSurfaceView对象"><a href="#构建一个GLSurfaceView对象" class="headerlink" title="构建一个GLSurfaceView对象"></a>构建一个GLSurfaceView对象</h5><p>  GLSurfaceView是一个特殊的view，用于绘制OpenGL ES图像的一个容器。其内部类GLSurfaceView.Renderer用于控制绘制。<br>  一般需要继承<code>GLSurfaceView</code>来用于自主控制各类触控事件。</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyGLSurfaceView</span> <span class="keyword">extends</span> <span class="title">GLSurfaceView</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MyGLRenderer mRenderer;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyGLSurfaceView</span><span class="params">(Context context)</span></span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line"></div><div class="line">        <span class="comment">// Create an OpenGL ES 2.0 context</span></div><div class="line">        setEGLContextClientVersion(<span class="number">2</span>);</div><div class="line"></div><div class="line">        mRenderer = <span class="keyword">new</span> MyGLRenderer();</div><div class="line"></div><div class="line">        <span class="comment">// Set the Renderer for drawing on the GLSurfaceView</span></div><div class="line">        setRenderer(mRenderer);</div><div class="line">        <span class="comment">// Render the view only when there is a change in the drawing data</span></div><div class="line">        <span class="comment">//设置此属性的话，除非调用requestRender()，否则GLSurfaceView不会刷新。只当有图像变化才会刷新。</span></div><div class="line">        setRenderMode(GLSurfaceView.RENDERMODE_WHEN_DIRTY);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><h5 id="构建一个渲染类"><a href="#构建一个渲染类" class="headerlink" title="构建一个渲染类"></a>构建一个渲染类</h5><p>  <code>GLSurfaceView.Renderer</code>被称为渲染器，控制图像绘制。Android可调用：</p>
<ul>
<li>onSurfaceCreated();调用一次，用于创建OpenGL ES环境</li>
<li>onDrawFrame();每次重绘View时调用。</li>
<li><p>onSurfaceChanged();View的几何形态变化时调用。</p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyGLRenderer</span> <span class="keyword">implements</span> <span class="title">GLSurfaceView</span>.<span class="title">Renderer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceCreated</span><span class="params">(GL10 unused, EGLConfig config)</span> </span>&#123;</div><div class="line">        <span class="comment">// 设置背景框架颜色，此处为黑色，ARGB值</span></div><div class="line">        GLES20.glClearColor(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawFrame</span><span class="params">(GL10 unused)</span> </span>&#123;</div><div class="line">        <span class="comment">// 重绘背景色</span></div><div class="line">        GLES20.glClear(GLES20.GL_COLOR_BUFFER_BIT);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceChanged</span><span class="params">(GL10 unused, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</div><div class="line">        GLES20.glViewport(<span class="number">0</span>, <span class="number">0</span>, width, height);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="2、定义shapes"><a href="#2、定义shapes" class="headerlink" title="2、定义shapes"></a>2、定义shapes</h4><p>了解了OpenGL ES的基本概念后，便可以学习如何绘制基本图形。</p>
<ul>
<li><p>定义一个三角形<br>  OpenGL ES允许我们使用三维空间坐标来绘制图形，通常会定义float坐标数组，为了高效此处使用了<br>  ByteBuffer：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Triangle</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> FloatBuffer vertexBuffer;<span class="comment">//浮点数组</span></div><div class="line"></div><div class="line">    <span class="comment">// 数组中含有的坐标点数</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COORDS_PER_VERTEX = <span class="number">3</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">float</span> triangleCoords[] = &#123;   <span class="comment">//坐标点逆时针顺序</span></div><div class="line">            <span class="number">0.0f</span>,  <span class="number">0.622008459f</span>, <span class="number">0.0f</span>, <span class="comment">// 顶点</span></div><div class="line">            -<span class="number">0.5f</span>, -<span class="number">0.311004243f</span>, <span class="number">0.0f</span>, <span class="comment">// 左下角</span></div><div class="line">            <span class="number">0.5f</span>, -<span class="number">0.311004243f</span>, <span class="number">0.0f</span>  <span class="comment">//右下角</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">//设置RGB，Alpha</span></div><div class="line">    <span class="keyword">float</span> color[] = &#123; <span class="number">0.63671875f</span>, <span class="number">0.76953125f</span>, <span class="number">0.22265625f</span>, <span class="number">1.0f</span> &#125;;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Triangle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// initialize vertex byte buffer for shape coordinates</span></div><div class="line">        ByteBuffer bb = ByteBuffer.allocateDirect(</div><div class="line">                <span class="comment">// (number of coordinate values * 4 bytes per float)</span></div><div class="line">                triangleCoords.length * <span class="number">4</span>);</div><div class="line">        <span class="comment">// use the device hardware's native byte order</span></div><div class="line">        bb.order(ByteOrder.nativeOrder());</div><div class="line"></div><div class="line">        <span class="comment">// create a floating point buffer from the ByteBuffer</span></div><div class="line">        vertexBuffer = bb.asFloatBuffer();</div><div class="line">        <span class="comment">// add the coordinates to the FloatBuffer</span></div><div class="line">        vertexBuffer.put(triangleCoords);</div><div class="line">        <span class="comment">// set the buffer to read the first coordinate</span></div><div class="line">        vertexBuffer.position(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  默认情况下，OpenGL ES会有一个[0,0,0]的三维坐标系。更多的需要参考OpenGL手册。</p>
</li>
<li>定义一个矩形<br>  如下示例演示通过定义两个三角形来实现一个矩形。<br>  <img src="/2017/03/27/第四篇、Android图像与动画/ccw-square.png" alt="矩形"><pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//绘制两个三角形，所以使用一个绘制列表来通知OpenGL如何绘制顶点。</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Square</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> FloatBuffer vertexBuffer;</div><div class="line">    <span class="keyword">private</span> ShortBuffer drawListBuffer;</div><div class="line"></div><div class="line">    <span class="comment">// number of coordinates per vertex in this array</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COORDS_PER_VERTEX = <span class="number">3</span>;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">float</span> squareCoords[] = &#123;</div><div class="line">            -<span class="number">0.5f</span>,  <span class="number">0.5f</span>, <span class="number">0.0f</span>,   <span class="comment">// top left</span></div><div class="line">            -<span class="number">0.5f</span>, -<span class="number">0.5f</span>, <span class="number">0.0f</span>,   <span class="comment">// bottom left</span></div><div class="line">            <span class="number">0.5f</span>, -<span class="number">0.5f</span>, <span class="number">0.0f</span>,   <span class="comment">// bottom right</span></div><div class="line">            <span class="number">0.5f</span>,  <span class="number">0.5f</span>, <span class="number">0.0f</span> &#125;; <span class="comment">// top right</span></div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">short</span> drawOrder[] = &#123; <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span> &#125;; <span class="comment">// order to draw vertices</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Square</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// initialize vertex byte buffer for shape coordinates</span></div><div class="line">        ByteBuffer bb = ByteBuffer.allocateDirect(</div><div class="line">        <span class="comment">// (# of coordinate values * 4 bytes per float)</span></div><div class="line">                squareCoords.length * <span class="number">4</span>);</div><div class="line">        bb.order(ByteOrder.nativeOrder());</div><div class="line">        vertexBuffer = bb.asFloatBuffer();</div><div class="line">        vertexBuffer.put(squareCoords);</div><div class="line">        vertexBuffer.position(<span class="number">0</span>);</div><div class="line"></div><div class="line">        <span class="comment">// initialize byte buffer for the draw list</span></div><div class="line">        ByteBuffer dlb = ByteBuffer.allocateDirect(</div><div class="line">        <span class="comment">// (# of coordinate values * 2 bytes per short)</span></div><div class="line">                drawOrder.length * <span class="number">2</span>);</div><div class="line">        dlb.order(ByteOrder.nativeOrder());</div><div class="line">        drawListBuffer = dlb.asShortBuffer();</div><div class="line">        drawListBuffer.put(drawOrder);</div><div class="line">        drawListBuffer.position(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre></li>
</ul>
<h4 id="3、绘制shapes"><a href="#3、绘制shapes" class="headerlink" title="3、绘制shapes"></a>3、绘制shapes</h4><p>如上小节只是介绍了如何定义一个shape图形，本节将介绍如何绘制出需要的图形。出于内存和效率考虑，<br>除非加载的图形变化，一般都在<code>onSurfaceCreated()</code>中初始化shape图形。</p>
<ul>
<li><h5 id="初始化图形"><a href="#初始化图形" class="headerlink" title="初始化图形"></a>初始化图形</h5>  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyGLRenderer</span> <span class="keyword">implements</span> <span class="title">GLSurfaceView</span>.<span class="title">Renderer</span> </span>&#123;</div><div class="line"></div><div class="line">    ...</div><div class="line">    <span class="keyword">private</span> Triangle mTriangle;</div><div class="line">    <span class="keyword">private</span> Square   mSquare;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceCreated</span><span class="params">(GL10 unused, EGLConfig config)</span> </span>&#123;</div><div class="line">        ...</div><div class="line"></div><div class="line">        <span class="comment">// initialize a triangle</span></div><div class="line">        mTriangle = <span class="keyword">new</span> Triangle();</div><div class="line">        <span class="comment">// initialize a square</span></div><div class="line">        mSquare = <span class="keyword">new</span> Square();</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  使用OpenGL ES 绘制一个定义好的图形，需要如下步骤：</p>
<ul>
<li>顶点着色器（Vertex Shader）：用于渲染顶点的OpenGL ES 代码</li>
<li>片段着色器（Fragment Shader）：使用颜色和纹理渲染图形表面的OpenGL ES 代码</li>
<li><p>程式（Program）： OpenGL ES对象，包含各类着色器等。</p>
<p>示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> String vertexShaderCode =</div><div class="line">    <span class="string">"attribute vec4 vPosition;"</span> +</div><div class="line">    <span class="string">"void main() &#123;"</span> +</div><div class="line">    <span class="string">"  gl_Position = vPosition;"</span> +</div><div class="line">    <span class="string">"&#125;"</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> String fragmentShaderCode =</div><div class="line">    <span class="string">"precision mediump float;"</span> +</div><div class="line">    <span class="string">"uniform vec4 vColor;"</span> +</div><div class="line">    <span class="string">"void main() &#123;"</span> +</div><div class="line">    <span class="string">"  gl_FragColor = vColor;"</span> +</div><div class="line">    <span class="string">"&#125;"</span>;</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure>
<p>着色器包含OpenGL Shading Language（GLSL）代码，需要先编译，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">loadShader</span><span class="params">(<span class="keyword">int</span> type, String shaderCode)</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// create a vertex shader type (GLES20.GL_VERTEX_SHADER)</span></div><div class="line">    <span class="comment">// or a fragment shader type (GLES20.GL_FRAGMENT_SHADER)</span></div><div class="line">    <span class="keyword">int</span> shader = GLES20.glCreateShader(type);</div><div class="line"></div><div class="line">    <span class="comment">// add the source code to the shader and compile it</span></div><div class="line">    GLES20.glShaderSource(shader, shaderCode);</div><div class="line">    GLES20.glCompileShader(shader);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> shader;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><h5 id="画图"><a href="#画图" class="headerlink" title="画图"></a>画图</h5><p>  为了绘制你的图形，你必须编译着色器代码，将它们添加至一个OpenGL ES Program对象中，然后执行链接。<br>  在你的绘制对象的构造函数里做这些事情，这样上述步骤就只用执行一次。</p>
<blockquote>
<p>Note：编译OpenGL ES着色器及链接操作对于CPU周期和处理时间而言，消耗是巨大的，所以你应该避免重复执行这些事情。<br>如果在执行期间不知道着色器的内容，那么你应该在构建你的应用时，确保它们只被创建了一次，并且缓存以备后续使用。</p>
</blockquote>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> class <span class="title">Triangle</span><span class="params">()</span> </span>&#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mProgram;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Triangle</span><span class="params">()</span> </span>&#123;</div><div class="line">        ...</div><div class="line"></div><div class="line">        <span class="keyword">int</span> vertexShader = MyGLRenderer.loadShader(GLES20.GL_VERTEX_SHADER,</div><div class="line">                                            vertexShaderCode);</div><div class="line">        <span class="keyword">int</span> fragmentShader = MyGLRenderer.loadShader(GLES20.GL_FRAGMENT_SHADER,</div><div class="line">                                            fragmentShaderCode);</div><div class="line"></div><div class="line">        <span class="comment">// create empty OpenGL ES Program</span></div><div class="line">        mProgram = GLES20.glCreateProgram();</div><div class="line"></div><div class="line">        <span class="comment">// add the vertex shader to program</span></div><div class="line">        GLES20.glAttachShader(mProgram, vertexShader);</div><div class="line">        <span class="comment">// add the fragment shader to program</span></div><div class="line">        GLES20.glAttachShader(mProgram, fragmentShader);</div><div class="line"></div><div class="line">        <span class="comment">// creates OpenGL ES program executables</span></div><div class="line">        GLES20.glLinkProgram(mProgram);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  绘制属性会根据图形而变化，就需要将变化逻辑一同写入绘制参数，</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> mPositionHandle;</div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> mColorHandle;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> vertexCount = triangleCoords.length / COORDS_PER_VERTEX;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> vertexStride = COORDS_PER_VERTEX * <span class="number">4</span>; <span class="comment">// 4 bytes per vertex</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// Add program to OpenGL ES environment</span></div><div class="line">    GLES20.glUseProgram(mProgram);</div><div class="line"></div><div class="line">    <span class="comment">// get handle to vertex shader's vPosition member</span></div><div class="line">    mPositionHandle = GLES20.glGetAttribLocation(mProgram, <span class="string">"vPosition"</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Enable a handle to the triangle vertices</span></div><div class="line">    GLES20.glEnableVertexAttribArray(mPositionHandle);</div><div class="line"></div><div class="line">    <span class="comment">// Prepare the triangle coordinate data</span></div><div class="line">    GLES20.glVertexAttribPointer(mPositionHandle, COORDS_PER_VERTEX,</div><div class="line">                                GLES20.GL_FLOAT, <span class="keyword">false</span>,</div><div class="line">                                vertexStride, vertexBuffer);</div><div class="line"></div><div class="line">    <span class="comment">// get handle to fragment shader's vColor member</span></div><div class="line">    mColorHandle = GLES20.glGetUniformLocation(mProgram, <span class="string">"vColor"</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Set color for drawing the triangle</span></div><div class="line">    GLES20.glUniform4fv(mColorHandle, <span class="number">1</span>, color, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Draw the triangle</span></div><div class="line">    GLES20.glDrawArrays(GLES20.GL_TRIANGLES, <span class="number">0</span>, vertexCount);</div><div class="line"></div><div class="line">    <span class="comment">// Disable vertex array</span></div><div class="line">    GLES20.glDisableVertexAttribArray(mPositionHandle);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  如此只需要在渲染器的<code>onDrawFrame()</code>中调用上面的<code>onDraw()</code>方法即可。<br>  <img src="/2017/03/27/第四篇、Android图像与动画/ogl-triangle.png" alt="绘制图形"></p>
<h4 id="3、运用投影和相机视角"><a href="#3、运用投影和相机视角" class="headerlink" title="3、运用投影和相机视角"></a>3、运用投影和相机视角</h4><p>在OpenGL ES 环境中，利用投影和相机视角可以将图像更为逼真的显示。</p>
</li>
</ul>
<ol>
<li>投影(Projection)：此类变化基于GLSurfaceView的长宽。</li>
<li>相机视角(Camera View):此类变化基于OpenGL ES 的虚拟相机。</li>
</ol>
<ul>
<li><h5 id="定义一个投影"><a href="#定义一个投影" class="headerlink" title="定义一个投影"></a>定义一个投影</h5>投影变换的数据计算在GLSurfaceView.Render类中的onSurfaceChanged()中执行。<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// mMVPMatrix is an abbreviation for "Model View Projection Matrix"</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">float</span>[] mMVPMatrix = <span class="keyword">new</span> <span class="keyword">float</span>[<span class="number">16</span>];</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">float</span>[] mProjectionMatrix = <span class="keyword">new</span> <span class="keyword">float</span>[<span class="number">16</span>];</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">float</span>[] mViewMatrix = <span class="keyword">new</span> <span class="keyword">float</span>[<span class="number">16</span>];</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceChanged</span><span class="params">(GL10 unused, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</div><div class="line">    GLES20.glViewport(<span class="number">0</span>, <span class="number">0</span>, width, height);</div><div class="line"></div><div class="line">    <span class="keyword">float</span> ratio = (<span class="keyword">float</span>) width / height;</div><div class="line"></div><div class="line">    <span class="comment">// this projection matrix is applied to object coordinates</span></div><div class="line">    <span class="comment">// in the onDrawFrame() method</span></div><div class="line">    Matrix.frustumM(mProjectionMatrix, <span class="number">0</span>, -ratio, ratio, -<span class="number">1</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">7</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>若是绘图只是用投影，会让图像显得空旷，最好结合相机视角来绘制。</p>
</blockquote>
<ul>
<li><h5 id="定义一个相机视角"><a href="#定义一个相机视角" class="headerlink" title="定义一个相机视角"></a>定义一个相机视角</h5>使用<code>Matrix.setLookAtM()</code>来换算计算，再结合如上投影换算：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawFrame</span><span class="params">(GL10 unused)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// Set the camera position (View matrix)</span></div><div class="line">    Matrix.setLookAtM(mViewMatrix, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, -<span class="number">3</span>, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Calculate the projection and view transformation</span></div><div class="line">    Matrix.multiplyMM(mMVPMatrix, <span class="number">0</span>, mProjectionMatrix, <span class="number">0</span>, mViewMatrix, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Draw shape</span></div><div class="line">    mTriangle.draw(mMVPMatrix);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>将上一节的三角形使用投影和视角绘制：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Triangle</span> </span>&#123;</div><div class="line">    <span class="comment">//为顶点添加渲染着色器，Matrix</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String vertexShaderCode =</div><div class="line">        <span class="comment">// This matrix member variable provides a hook to manipulate</span></div><div class="line">        <span class="comment">// the coordinates of the objects that use this vertex shader</span></div><div class="line">        <span class="string">"uniform mat4 uMVPMatrix;"</span> +</div><div class="line">        <span class="string">"attribute vec4 vPosition;"</span> +</div><div class="line">        <span class="string">"void main() &#123;"</span> +</div><div class="line">        <span class="comment">// the matrix must be included as a modifier of gl_Position</span></div><div class="line">        <span class="comment">// Note that the uMVPMatrix factor *must be first* in order</span></div><div class="line">        <span class="comment">// for the matrix multiplication product to be correct.</span></div><div class="line">        <span class="string">"  gl_Position = uMVPMatrix * vPosition;"</span> +</div><div class="line">        <span class="string">"&#125;"</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Use to access and set the view transformation</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mMVPMatrixHandle;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>修改<code>onDraw ()</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">float</span>[] mvpMatrix)</span> </span>&#123; <span class="comment">// pass in the calculated transformation matrix</span></div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="comment">// get handle to shape's transformation matrix</span></div><div class="line">    mMVPMatrixHandle = GLES20.glGetUniformLocation(mProgram, <span class="string">"uMVPMatrix"</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Pass the projection and view transformation to the shader</span></div><div class="line">    GLES20.glUniformMatrix4fv(mMVPMatrixHandle, <span class="number">1</span>, <span class="keyword">false</span>, mvpMatrix, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Draw the triangle</span></div><div class="line">    GLES20.glDrawArrays(GLES20.GL_TRIANGLES, <span class="number">0</span>, vertexCount);</div><div class="line"></div><div class="line">    <span class="comment">// Disable vertex array</span></div><div class="line">    GLES20.glDisableVertexAttribArray(mPositionHandle);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>效果如图：<img src="/2017/03/27/第四篇、Android图像与动画/ogl-triangle-projected.png" alt="视角绘图"></p>
<h4 id="4、添加移动"><a href="#4、添加移动" class="headerlink" title="4、添加移动"></a>4、添加移动</h4><p>OpenGL 区别于Android的canvas和Drawable图形框架，在于其提供的特殊功能，如3D效果等。</p>
<ul>
<li><h5 id="旋转图像"><a href="#旋转图像" class="headerlink" title="旋转图像"></a>旋转图像</h5>在OpenGL ES2.0中新增一个变化矩阵，结合之前的投影和视角，来绘制图形移动。<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">float</span>[] mRotationMatrix = <span class="keyword">new</span> <span class="keyword">float</span>[<span class="number">16</span>];</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawFrame</span><span class="params">(GL10 gl)</span> </span>&#123;</div><div class="line">    <span class="keyword">float</span>[] scratch = <span class="keyword">new</span> <span class="keyword">float</span>[<span class="number">16</span>];</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="comment">// Create a rotation transformation for the triangle</span></div><div class="line">    <span class="keyword">long</span> time = SystemClock.uptimeMillis() % <span class="number">4000L</span>;</div><div class="line">    <span class="keyword">float</span> angle = <span class="number">0.090f</span> * ((<span class="keyword">int</span>) time);</div><div class="line">    Matrix.setRotateM(mRotationMatrix, <span class="number">0</span>, angle, <span class="number">0</span>, <span class="number">0</span>, -<span class="number">1.0f</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Combine the rotation matrix with the projection and camera view</span></div><div class="line">    <span class="comment">// Note that the mMVPMatrix factor *must be first* in order</span></div><div class="line">    <span class="comment">// for the matrix multiplication product to be correct.</span></div><div class="line">    Matrix.multiplyMM(scratch, <span class="number">0</span>, mMVPMatrix, <span class="number">0</span>, mRotationMatrix, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Draw triangle</span></div><div class="line">    mTriangle.draw(scratch);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p><strong>Note:</strong> 不要将<code>GLSurfaceView.RENDERMODE_WHEN_DIRTY</code>注释掉，否则就可能不会移动，也不会渲染。</p>
</blockquote>
<ul>
<li><h5 id="启用连续渲染"><a href="#启用连续渲染" class="headerlink" title="启用连续渲染"></a>启用连续渲染</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">MyGLSurfaceView</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// Render the view only when there is a change in the drawing data.</span></div><div class="line">    <span class="comment">// To allow the triangle to rotate automatically, this line is commented out:</span></div><div class="line">    <span class="comment">//setRenderMode(GLSurfaceView.RENDERMODE_WHEN_DIRTY);</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="5、响应触摸事件"><a href="#5、响应触摸事件" class="headerlink" title="5、响应触摸事件"></a>5、响应触摸事件</h4><p>炫酷的图形图像，也可以和用户有良好的交互体验。重写<code>GLSurfaceView</code>类的<code>onTouchEvent()</code>方法<br>来响应触摸事件。</p>
<ul>
<li><h5 id="注册监听"><a href="#注册监听" class="headerlink" title="注册监听"></a>注册监听</h5>在重写<code>onTouchEvent()</code>方法后，想要完成事件相应，就需要注册监听。<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">float</span> TOUCH_SCALE_FACTOR = <span class="number">180.0f</span> / <span class="number">320</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">float</span> mPreviousX;</div><div class="line"><span class="keyword">private</span> <span class="keyword">float</span> mPreviousY;</div><div class="line"><span class="comment">//复写onTouchEvent方法，本文用于响应MotionEvent.ACTION_MOVE事件</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent e)</span> </span>&#123;</div><div class="line">    <span class="comment">// MotionEvent reports input details from the touch screen</span></div><div class="line">    <span class="comment">// and other input controls. In this case, you are only</span></div><div class="line">    <span class="comment">// interested in events where the touch position changed.</span></div><div class="line"></div><div class="line">    <span class="keyword">float</span> x = e.getX();</div><div class="line">    <span class="keyword">float</span> y = e.getY();</div><div class="line"></div><div class="line">    <span class="keyword">switch</span> (e.getAction()) &#123;</div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</div><div class="line"></div><div class="line">            <span class="keyword">float</span> dx = x - mPreviousX;</div><div class="line">            <span class="keyword">float</span> dy = y - mPreviousY;</div><div class="line"></div><div class="line">            <span class="comment">// reverse direction of rotation above the mid-line</span></div><div class="line">            <span class="keyword">if</span> (y &gt; getHeight() / <span class="number">2</span>) &#123;</div><div class="line">              dx = dx * -<span class="number">1</span> ;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// reverse direction of rotation to left of the mid-line</span></div><div class="line">            <span class="keyword">if</span> (x &lt; getWidth() / <span class="number">2</span>) &#123;</div><div class="line">              dy = dy * -<span class="number">1</span> ;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            mRenderer.setAngle(</div><div class="line">                    mRenderer.getAngle() +</div><div class="line">                    ((dx + dy) * TOUCH_SCALE_FACTOR));</div><div class="line">            requestRender();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mPreviousX = x;</div><div class="line">    mPreviousY = y;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>如上代码调用<code>requestRender()</code>来刷新绘制，通过<code>setRenderMode()</code>来提高效率，只有变化时候才绘制：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">MyGLSurfaceView</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// Render the view only when there is a change in the drawing data</span></div><div class="line">    setRenderMode(GLSurfaceView.RENDERMODE_WHEN_DIRTY);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><h5 id="公开变量旋转角度"><a href="#公开变量旋转角度" class="headerlink" title="公开变量旋转角度"></a>公开变量旋转角度</h5>旋转角度的变量需要public，包括get和set方法<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyGLRenderer</span> <span class="keyword">implements</span> <span class="title">GLSurfaceView</span>.<span class="title">Renderer</span> </span>&#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">float</span> mAngle;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getAngle</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mAngle;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAngle</span><span class="params">(<span class="keyword">float</span> angle)</span> </span>&#123;</div><div class="line">        mAngle = angle;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>然后在调用绘制图形的地方，填入角度值，启动旋转。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawFrame</span><span class="params">(GL10 gl)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">float</span>[] scratch = <span class="keyword">new</span> <span class="keyword">float</span>[<span class="number">16</span>];</div><div class="line"></div><div class="line">    <span class="comment">// Create a rotation for the triangle</span></div><div class="line">    <span class="comment">// long time = SystemClock.uptimeMillis() % 4000L;</span></div><div class="line">    <span class="comment">// float angle = 0.090f * ((int) time);</span></div><div class="line">    Matrix.setRotateM(mRotationMatrix, <span class="number">0</span>, mAngle, <span class="number">0</span>, <span class="number">0</span>, -<span class="number">1.0f</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Combine the rotation matrix with the projection and camera view</span></div><div class="line">    <span class="comment">// Note that the mMVPMatrix factor *must be first* in order</span></div><div class="line">    <span class="comment">// for the matrix multiplication product to be correct.</span></div><div class="line">    Matrix.multiplyMM(scratch, <span class="number">0</span>, mMVPMatrix, <span class="number">0</span>, mRotationMatrix, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Draw triangle</span></div><div class="line">    mTriangle.draw(scratch);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>滑动效果：<img src="/2017/03/27/第四篇、Android图像与动画/ogl-triangle-touch.png" alt="滑动效果"></p>
<h3 id="3、添加动画"><a href="#3、添加动画" class="headerlink" title="3、添加动画"></a>3、添加动画</h3><p>动画效果可以让我们的App更为炫酷，但是也要在适当的地方和时机使用它。本章主要介绍Android的一些动画效果实现。</p>
<h4 id="1、View间渐变"><a href="#1、View间渐变" class="headerlink" title="1、View间渐变"></a>1、View间渐变</h4><p>渐变动画通常用于View的切换，淡入淡出效果。<a href="http://hukai.me/android-training-course-in-chinese/animations/anim_crossfade.mp4" target="_blank" rel="external">渐变动画</a></p>
<ul>
<li><h5 id="创建View"><a href="#创建View" class="headerlink" title="创建View"></a>创建View</h5><p>示例，一个进度圈和可滑动的view</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">FrameLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">ScrollView</span> <span class="attr">xmlns:android</span>=<span class="string">"/apk/res/android"</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/content"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span> <span class="attr">style</span>=<span class="string">"?android:textAppearanceMedium"</span></span></div><div class="line">            <span class="attr">android:lineSpacingMultiplier</span>=<span class="string">"1.2"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">            <span class="attr">android:text</span>=<span class="string">"@string/lorem_ipsum"</span></div><div class="line">            <span class="attr">android:padding</span>=<span class="string">"16dp"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">ScrollView</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">ProgressBar</span> <span class="attr">android:id</span>=<span class="string">"@+id/loading_spinner"</span></span></div><div class="line">        <span class="attr">style</span>=<span class="string">"?android:progressBarStyleLarge"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_gravity</span>=<span class="string">"center"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><h5 id="view设置动画"><a href="#view设置动画" class="headerlink" title="view设置动画"></a>view设置动画</h5><p>为上面的view设置动画效果，步骤如下：</p>
</li>
</ul>
<ol>
<li>设置view的成员变量，以备后用。</li>
<li>先设置淡入的View的visible为gone</li>
<li>将<code>config_shortAnimTime</code>系统属性暂存到成员变量。</li>
</ol>
<p>示例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CrossfadeActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> View mContentView;</div><div class="line">    <span class="keyword">private</span> View mLoadingView;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mShortAnimationDuration;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_crossfade);</div><div class="line"></div><div class="line">        mContentView = findViewById(R.id.content);</div><div class="line">        mLoadingView = findViewById(R.id.loading_spinner);</div><div class="line"></div><div class="line">        <span class="comment">// Initially hide the content view.</span></div><div class="line">        mContentView.setVisibility(View.GONE);</div><div class="line"></div><div class="line">        <span class="comment">// Retrieve and cache the system's default "short" animation time.</span></div><div class="line">        mShortAnimationDuration = getResources().getInteger(</div><div class="line">                android.R.integer.config_shortAnimTime);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><h5 id="渐变View"><a href="#渐变View" class="headerlink" title="渐变View"></a>渐变View</h5>完成如上设置后，开始实现View的渐变效果：</li>
</ul>
<ol>
<li>将需要淡入的View的Visible改为VISIBLE，透明度alpha=0</li>
<li>将淡入的View，alpha从0–1，淡出的View，alpha从1–0</li>
<li>使用<code>Animator.AnimatorListener</code>中的<code>onAnimationEnd()</code>来设置淡出的view的visible为gone，即使alpha=0，但是也会占用布局资源，所以需要gone。<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> View mContentView;</div><div class="line"><span class="keyword">private</span> View mLoadingView;</div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> mShortAnimationDuration;</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">crossfade</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// Set the content view to 0% opacity but visible, so that it is visible</span></div><div class="line">    <span class="comment">// (but fully transparent) during the animation.</span></div><div class="line">    mContentView.setAlpha(<span class="number">0f</span>);</div><div class="line">    mContentView.setVisibility(View.VISIBLE);</div><div class="line"></div><div class="line">    <span class="comment">// Animate the content view to 100% opacity, and clear any animation</span></div><div class="line">    <span class="comment">// listener set on the view.</span></div><div class="line">    mContentView.animate()</div><div class="line">            .alpha(<span class="number">1f</span>)</div><div class="line">            .setDuration(mShortAnimationDuration)</div><div class="line">            .setListener(<span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Animate the loading view to 0% opacity. After the animation ends,</span></div><div class="line">    <span class="comment">// set its visibility to GONE as an optimization step (it won't</span></div><div class="line">    <span class="comment">// participate in layout passes, etc.)</span></div><div class="line">    mLoadingView.animate()</div><div class="line">            .alpha(<span class="number">0f</span>)</div><div class="line">            .setDuration(mShortAnimationDuration)</div><div class="line">            .setListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">                    mLoadingView.setVisibility(View.GONE);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="2、使用Viewpager实现屏幕滑动"><a href="#2、使用Viewpager实现屏幕滑动" class="headerlink" title="2、使用Viewpager实现屏幕滑动"></a>2、使用Viewpager实现屏幕滑动</h4><p>类似View的淡入淡出切换，而屏幕的切换是整个的界面转换，使用<code>supports library</code>的ViewPager来实现。<br><a href="http://hukai.me/android-training-course-in-chinese/animations/anim_screenslide.mp4" target="_blank" rel="external">ViewPager</a></p>
<ul>
<li><h5 id="创建View-1"><a href="#创建View-1" class="headerlink" title="创建View"></a>创建View</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- fragment_screen_slide_page.xml --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">ScrollView</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/content"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span> &gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span> <span class="attr">style</span>=<span class="string">"?android:textAppearanceMedium"</span></span></div><div class="line">        <span class="attr">android:padding</span>=<span class="string">"16dp"</span></div><div class="line">        <span class="attr">android:lineSpacingMultiplier</span>=<span class="string">"1.2"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"@string/lorem_ipsum"</span> /&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">ScrollView</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>如上定义一个fragment和text view</p>
<ul>
<li><h5 id="创建Fragment"><a href="#创建Fragment" class="headerlink" title="创建Fragment"></a>创建Fragment</h5><p>创建一个Fragment对象实例来展示view布局。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> android.support.v4.app.Fragment;</div><div class="line">...</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScreenSlidePageFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container,</span></span></div><div class="line">            Bundle savedInstanceState) &#123;</div><div class="line">        ViewGroup rootView = (ViewGroup) inflater.inflate(</div><div class="line">                R.layout.fragment_screen_slide_page, container, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> rootView;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><h5 id="添加viewPager"><a href="#添加viewPager" class="headerlink" title="添加viewPager"></a>添加viewPager</h5><p>ViewPager有内建的滑动手势，配合PagerAdapter来适配数据。需要创建一个包含ViewPager的布局</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- activity_screen_slide.xml --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">android.support.v4.view.ViewPager</span></span></div><div class="line">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/pager"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span> /&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>接下来就是创建一个Activity来关联布局，实现逻辑：</p>
<ol>
<li>content View中包含上述布局文件</li>
<li>创建<code>FragmentStatePagerAdapter</code>的子类，实现<code>getItem()</code>方法，把ScreenSlidePageFragment实例作为新页面补充进来。<br>PagerAdapter还需要实现getCount()方法，它返回 Adapter将要创建页面的总数（例如5个）。</li>
<li>关联<code>ViewPager</code>和<code>PagerAdapter</code></li>
<li>处理Back按钮，按下变为在虚拟的Fragment栈中回退。如果用户已经在第一个页面了，<br>则在Activity的回退栈（back stack）中回退。<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> android.support.v4.app.Fragment;</div><div class="line"><span class="keyword">import</span> android.support.v4.app.FragmentManager;</div><div class="line">...</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScreenSlidePagerActivity</span> <span class="keyword">extends</span> <span class="title">FragmentActivity</span> </span>&#123;</div><div class="line">    <span class="comment">//屏幕页面数目</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NUM_PAGES = <span class="number">5</span>;</div><div class="line"></div><div class="line">    <span class="comment">//View Pager对象，用于处理页面切换的容器</span></div><div class="line">    <span class="keyword">private</span> ViewPager mPager;</div><div class="line"></div><div class="line">    <span class="comment">//页面数据适配器</span></div><div class="line">    <span class="keyword">private</span> PagerAdapter mPagerAdapter;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_screen_slide);</div><div class="line"></div><div class="line">        <span class="comment">// 初始化数据</span></div><div class="line">        mPager = (ViewPager) findViewById(R.id.pager);</div><div class="line">        mPagerAdapter = <span class="keyword">new</span> ScreenSlidePagerAdapter(getSupportFragmentManager());</div><div class="line">        mPager.setAdapter(mPagerAdapter);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//处理返回按钮的点击事件</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBackPressed</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mPager.getCurrentItem() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">//要是第一个页面，返回按钮就是退出</span></div><div class="line">            <span class="keyword">super</span>.onBackPressed();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//不是第一个页面，返回按钮就是返回上一个页面</span></div><div class="line">            mPager.setCurrentItem(mPager.getCurrentItem() - <span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//简单的适配器，用于加入几个页面</span></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ScreenSlidePagerAdapter</span> <span class="keyword">extends</span> <span class="title">FragmentStatePagerAdapter</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ScreenSlidePagerAdapter</span><span class="params">(FragmentManager fm)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(fm);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Fragment <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ScreenSlidePageFragment();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> NUM_PAGES;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>ViewPager包含有默认的滑屏动画，若要自定义切换动画需要实现<code>viewpager.transformer</code>接口，并补充道Viewpager中<br>，实现其方法<code>transformPage()</code>。该方法会在显示页面滑动时，于其相邻的两个页面间调用。重要的参数就是当前页面<br>的位置position，可以根据页面位置来设置不同的动画效果。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ViewPager mPager = (ViewPager) findViewById(R.id.pager);</div><div class="line">...</div><div class="line">mPager.setPagerTransformer(<span class="keyword">true</span>,<span class="keyword">new</span> ZoomOutPagerTransformer());</div></pre></td></tr></table></figure></p>
<ul>
<li><h5 id="ZoomOutPagerTransformer"><a href="#ZoomOutPagerTransformer" class="headerlink" title="ZoomOutPagerTransformer"></a>ZoomOutPagerTransformer</h5><p>效果是逐渐褪色的淡出模式<a href="http://hukai.me/android-training-course-in-chinese/animations/anim_page_transformer_zoomout.mp4" target="_blank" rel="external">演示</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZoomOutPageTransformer</span> <span class="keyword">implements</span> <span class="title">ViewPager</span>.<span class="title">PageTransformer</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> MIN_SCALE = <span class="number">0.85f</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> MIN_ALPHA = <span class="number">0.5f</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transformPage</span><span class="params">(View view, <span class="keyword">float</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> pageWidth = view.getWidth();</div><div class="line">        <span class="keyword">int</span> pageHeight = view.getHeight();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (position &lt; -<span class="number">1</span>) &#123; <span class="comment">// [-Infinity,-1)</span></div><div class="line">            <span class="comment">// This page is way off-screen to the left.</span></div><div class="line">            view.setAlpha(<span class="number">0</span>);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position &lt;= <span class="number">1</span>) &#123; <span class="comment">// [-1,1]</span></div><div class="line">            <span class="comment">// Modify the default slide transition to shrink the page as well</span></div><div class="line">            <span class="keyword">float</span> scaleFactor = Math.max(MIN_SCALE, <span class="number">1</span> - Math.abs(position));</div><div class="line">            <span class="keyword">float</span> vertMargin = pageHeight * (<span class="number">1</span> - scaleFactor) / <span class="number">2</span>;</div><div class="line">            <span class="keyword">float</span> horzMargin = pageWidth * (<span class="number">1</span> - scaleFactor) / <span class="number">2</span>;</div><div class="line">            <span class="keyword">if</span> (position &lt; <span class="number">0</span>) &#123;</div><div class="line">                view.setTranslationX(horzMargin - vertMargin / <span class="number">2</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                view.setTranslationX(-horzMargin + vertMargin / <span class="number">2</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Scale the page down (between MIN_SCALE and 1)</span></div><div class="line">            view.setScaleX(scaleFactor);</div><div class="line">            view.setScaleY(scaleFactor);</div><div class="line"></div><div class="line">            <span class="comment">// Fade the page relative to its size.</span></div><div class="line">            view.setAlpha(MIN_ALPHA +</div><div class="line">                    (scaleFactor - MIN_SCALE) /</div><div class="line">                    (<span class="number">1</span> - MIN_SCALE) * (<span class="number">1</span> - MIN_ALPHA));</div><div class="line"></div><div class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// (1,+Infinity]</span></div><div class="line">            <span class="comment">// This page is way off-screen to the right.</span></div><div class="line">            view.setAlpha(<span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><h5 id="Depth-Pager-Transformer"><a href="#Depth-Pager-Transformer" class="headerlink" title="Depth Pager Transformer"></a>Depth Pager Transformer</h5><p>右滑动潜藏效果<a href="http://hukai.me/android-training-course-in-chinese/animations/anim_page_transformer_depth.mp4" target="_blank" rel="external">video</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DepthPageTransformer</span> <span class="keyword">implements</span> <span class="title">ViewPager</span>.<span class="title">PageTransformer</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> MIN_SCALE = <span class="number">0.75f</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transformPage</span><span class="params">(View view, <span class="keyword">float</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> pageWidth = view.getWidth();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (position &lt; -<span class="number">1</span>) &#123; <span class="comment">// [-Infinity,-1)</span></div><div class="line">            <span class="comment">// This page is way off-screen to the left.</span></div><div class="line">            view.setAlpha(<span class="number">0</span>);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position &lt;= <span class="number">0</span>) &#123; <span class="comment">// [-1,0]</span></div><div class="line">            <span class="comment">// Use the default slide transition when moving to the left page</span></div><div class="line">            view.setAlpha(<span class="number">1</span>);</div><div class="line">            view.setTranslationX(<span class="number">0</span>);</div><div class="line">            view.setScaleX(<span class="number">1</span>);</div><div class="line">            view.setScaleY(<span class="number">1</span>);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (position &lt;= <span class="number">1</span>) &#123; <span class="comment">// (0,1]</span></div><div class="line">            <span class="comment">// Fade the page out.</span></div><div class="line">            view.setAlpha(<span class="number">1</span> - position);</div><div class="line"></div><div class="line">            <span class="comment">// Counteract the default slide transition</span></div><div class="line">            view.setTranslationX(pageWidth * -position);</div><div class="line"></div><div class="line">            <span class="comment">// Scale the page down (between MIN_SCALE and 1)</span></div><div class="line">            <span class="keyword">float</span> scaleFactor = MIN_SCALE</div><div class="line">                    + (<span class="number">1</span> - MIN_SCALE) * (<span class="number">1</span> - Math.abs(position));</div><div class="line">            view.setScaleX(scaleFactor);</div><div class="line">            view.setScaleY(scaleFactor);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// (1,+Infinity]</span></div><div class="line">            <span class="comment">// This page is way off-screen to the right.</span></div><div class="line">            view.setAlpha(<span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="3、实现Card翻转动画"><a href="#3、实现Card翻转动画" class="headerlink" title="3、实现Card翻转动画"></a>3、实现Card翻转动画</h4><p>通过自定义Fragment实现Card翻转效果的view切换。<a href="http://hukai.me/android-training-course-in-chinese/animations/anim_card_flip.mp4" target="_blank" rel="external">card</a></p>
<ul>
<li><h5 id="创建Animator"><a href="#创建Animator" class="headerlink" title="创建Animator"></a>创建Animator</h5>创建Card翻转动画，我们需要两个Animator。一个让正面的card的右侧向左翻转渐出，一个让背面的Card向右翻转渐入。我们还需要两个 Animator让背面的card的右侧向左翻转渐入，一个让向右翻转渐入。</li>
</ul>
<p><strong>card_flip_left_in.xml</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">set</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- Before rotating, immediately set the alpha to 0. --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">objectAnimator</span></span></div><div class="line">        <span class="attr">android:valueFrom</span>=<span class="string">"1.0"</span></div><div class="line">        <span class="attr">android:valueTo</span>=<span class="string">"0.0"</span></div><div class="line">        <span class="attr">android:propertyName</span>=<span class="string">"alpha"</span></div><div class="line">        <span class="attr">android:duration</span>=<span class="string">"0"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- Rotate. --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">objectAnimator</span></span></div><div class="line">        <span class="attr">android:valueFrom</span>=<span class="string">"-180"</span></div><div class="line">        <span class="attr">android:valueTo</span>=<span class="string">"0"</span></div><div class="line">        <span class="attr">android:propertyName</span>=<span class="string">"rotationY"</span></div><div class="line">        <span class="attr">android:interpolator</span>=<span class="string">"@android:interpolator/accelerate_decelerate"</span></div><div class="line">        <span class="attr">android:duration</span>=<span class="string">"@integer/card_flip_time_full"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- Half-way through the rotation (see startOffset), set the alpha to 1. --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">objectAnimator</span></span></div><div class="line">        <span class="attr">android:valueFrom</span>=<span class="string">"0.0"</span></div><div class="line">        <span class="attr">android:valueTo</span>=<span class="string">"1.0"</span></div><div class="line">        <span class="attr">android:propertyName</span>=<span class="string">"alpha"</span></div><div class="line">        <span class="attr">android:startOffset</span>=<span class="string">"@integer/card_flip_time_half"</span></div><div class="line">        <span class="attr">android:duration</span>=<span class="string">"1"</span> /&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">set</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><strong>card_flip_left_out.xml</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">set</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- Rotate. --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">objectAnimator</span></span></div><div class="line">        <span class="attr">android:valueFrom</span>=<span class="string">"0"</span></div><div class="line">        <span class="attr">android:valueTo</span>=<span class="string">"180"</span></div><div class="line">        <span class="attr">android:propertyName</span>=<span class="string">"rotationY"</span></div><div class="line">        <span class="attr">android:interpolator</span>=<span class="string">"@android:interpolator/accelerate_decelerate"</span></div><div class="line">        <span class="attr">android:duration</span>=<span class="string">"@integer/card_flip_time_full"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- Half-way through the rotation (see startOffset), set the alpha to 0. --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">objectAnimator</span></span></div><div class="line">        <span class="attr">android:valueFrom</span>=<span class="string">"1.0"</span></div><div class="line">        <span class="attr">android:valueTo</span>=<span class="string">"0.0"</span></div><div class="line">        <span class="attr">android:propertyName</span>=<span class="string">"alpha"</span></div><div class="line">        <span class="attr">android:startOffset</span>=<span class="string">"@integer/card_flip_time_half"</span></div><div class="line">        <span class="attr">android:duration</span>=<span class="string">"1"</span> /&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">set</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><strong>card_flip_right_in.xml</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">set</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- Before rotating, immediately set the alpha to 0. --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">objectAnimator</span></span></div><div class="line">        <span class="attr">android:valueFrom</span>=<span class="string">"1.0"</span></div><div class="line">        <span class="attr">android:valueTo</span>=<span class="string">"0.0"</span></div><div class="line">        <span class="attr">android:propertyName</span>=<span class="string">"alpha"</span></div><div class="line">        <span class="attr">android:duration</span>=<span class="string">"0"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- Rotate. --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">objectAnimator</span></span></div><div class="line">        <span class="attr">android:valueFrom</span>=<span class="string">"180"</span></div><div class="line">        <span class="attr">android:valueTo</span>=<span class="string">"0"</span></div><div class="line">        <span class="attr">android:propertyName</span>=<span class="string">"rotationY"</span></div><div class="line">        <span class="attr">android:interpolator</span>=<span class="string">"@android:interpolator/accelerate_decelerate"</span></div><div class="line">        <span class="attr">android:duration</span>=<span class="string">"@integer/card_flip_time_full"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- Half-way through the rotation (see startOffset), set the alpha to 1. --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">objectAnimator</span></span></div><div class="line">        <span class="attr">android:valueFrom</span>=<span class="string">"0.0"</span></div><div class="line">        <span class="attr">android:valueTo</span>=<span class="string">"1.0"</span></div><div class="line">        <span class="attr">android:propertyName</span>=<span class="string">"alpha"</span></div><div class="line">        <span class="attr">android:startOffset</span>=<span class="string">"@integer/card_flip_time_half"</span></div><div class="line">        <span class="attr">android:duration</span>=<span class="string">"1"</span> /&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">set</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><strong>card_flip_right_out.xml</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">set</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- Rotate. --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">objectAnimator</span></span></div><div class="line">        <span class="attr">android:valueFrom</span>=<span class="string">"0"</span></div><div class="line">        <span class="attr">android:valueTo</span>=<span class="string">"-180"</span></div><div class="line">        <span class="attr">android:propertyName</span>=<span class="string">"rotationY"</span></div><div class="line">        <span class="attr">android:interpolator</span>=<span class="string">"@android:interpolator/accelerate_decelerate"</span></div><div class="line">        <span class="attr">android:duration</span>=<span class="string">"@integer/card_flip_time_full"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- Half-way through the rotation (see startOffset), set the alpha to 0. --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">objectAnimator</span></span></div><div class="line">        <span class="attr">android:valueFrom</span>=<span class="string">"1.0"</span></div><div class="line">        <span class="attr">android:valueTo</span>=<span class="string">"0.0"</span></div><div class="line">        <span class="attr">android:propertyName</span>=<span class="string">"alpha"</span></div><div class="line">        <span class="attr">android:startOffset</span>=<span class="string">"@integer/card_flip_time_half"</span></div><div class="line">        <span class="attr">android:duration</span>=<span class="string">"1"</span> /&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">set</span>&gt;</span></div></pre></td></tr></table></figure></p>
<ul>
<li><h5 id="创建View-2"><a href="#创建View-2" class="headerlink" title="创建View"></a>创建View</h5>card的每个面都是一个布局，需要在Fragment中关联展示<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></div><div class="line">    <span class="attr">android:background</span>=<span class="string">"#a6c"</span></div><div class="line">    <span class="attr">android:padding</span>=<span class="string">"16dp"</span></div><div class="line">    <span class="attr">android:gravity</span>=<span class="string">"bottom"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:id</span>=<span class="string">"@android:id/text1"</span></span></div><div class="line">        <span class="attr">style</span>=<span class="string">"?android:textAppearanceLarge"</span></div><div class="line">        <span class="attr">android:textStyle</span>=<span class="string">"bold"</span></div><div class="line">        <span class="attr">android:textColor</span>=<span class="string">"#fff"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"@string/card_back_title"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span> <span class="attr">style</span>=<span class="string">"?android:textAppearanceSmall"</span></span></div><div class="line">        <span class="attr">android:textAllCaps</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">android:textColor</span>=<span class="string">"#80ffffff"</span></div><div class="line">        <span class="attr">android:textStyle</span>=<span class="string">"bold"</span></div><div class="line">        <span class="attr">android:lineSpacingMultiplier</span>=<span class="string">"1.2"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"@string/card_back_description"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>另一面：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">ImageView</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:src</span>=<span class="string">"@drawable/image1"</span></div><div class="line">    <span class="attr">android:scaleType</span>=<span class="string">"centerCrop"</span></div><div class="line">    <span class="attr">android:contentDescription</span>=<span class="string">"@string/description_image_1"</span> /&gt;</div></pre></td></tr></table></figure></p>
<ul>
<li><h5 id="创建Fragment-1"><a href="#创建Fragment-1" class="headerlink" title="创建Fragment"></a>创建Fragment</h5><p>Card的正反面都是Fragment，需要创建并关联布局</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CardFlipActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * A fragment representing the front of the card.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CardFrontFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container,</span></span></div><div class="line">                Bundle savedInstanceState) &#123;</div><div class="line">            <span class="keyword">return</span> inflater.inflate(R.layout.fragment_card_front, container, <span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * A fragment representing the back of the card.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CardBackFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container,</span></span></div><div class="line">                Bundle savedInstanceState) &#123;</div><div class="line">            <span class="keyword">return</span> inflater.inflate(R.layout.fragment_card_back, container, <span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><h5 id="实现翻转Card动画"><a href="#实现翻转Card动画" class="headerlink" title="实现翻转Card动画"></a>实现翻转Card动画</h5><p>创建一个framelayout来用于activity展示fragment</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">FrameLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/container"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span> /&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>在Activity中实现展示<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CardFlipActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_activity_card_flip);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (savedInstanceState == <span class="keyword">null</span>) &#123;</div><div class="line">            getFragmentManager()</div><div class="line">                    .beginTransaction()</div><div class="line">                    .add(R.id.container, <span class="keyword">new</span> CardFrontFragment())</div><div class="line">                    .commit();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如上默认展示了card的正面，需要适时创建card的背面，并实现翻转。</p>
<ol>
<li><p>将Fragment转换设置我们刚做的自定义动画</p>
</li>
<li><p>用新Fragment替换当前显示的Fragment，并且应用之前创建的动画到该事件中。</p>
</li>
<li><p>添加之前显示的Fragment到Fragment的回退栈（back stack）中，所以当用户按下 Back 键时，Card会翻转回来。</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">flipCard</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mShowingBack) &#123;</div><div class="line">        getFragmentManager().popBackStack();</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 是否正在翻转</span></div><div class="line"></div><div class="line">    mShowingBack = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 创建并执行一个事务，新增fragment并应用自定义动画，且将fragment加入回退栈</span></div><div class="line"></div><div class="line">    getFragmentManager()</div><div class="line">            .beginTransaction()</div><div class="line"></div><div class="line">            <span class="comment">// 使用自定义动画</span></div><div class="line">            .setCustomAnimations(</div><div class="line">                    R.animator.card_flip_right_in, R.animator.card_flip_right_out,</div><div class="line">                    R.animator.card_flip_left_in, R.animator.card_flip_left_out)</div><div class="line"></div><div class="line">            <span class="comment">// 翻转的fragment</span></div><div class="line">            .replace(R.id.container, <span class="keyword">new</span> CardBackFragment())</div><div class="line"></div><div class="line">            <span class="comment">// 新增事务到回退栈</span></div><div class="line">            .addToBackStack(<span class="keyword">null</span>)</div><div class="line"></div><div class="line">            <span class="comment">// 提交事务</span></div><div class="line">            .commit();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="4、View的缩放"><a href="#4、View的缩放" class="headerlink" title="4、View的缩放"></a>4、View的缩放</h4><p>View的动画缩放效果，常用语图片的浏览展示。<a href="http://hukai.me/android-training-course-in-chinese/animations/anim_zoom.mp4" target="_blank" rel="external">scale</a></p>
<ul>
<li><h5 id="创建View-3"><a href="#创建View-3" class="headerlink" title="创建View"></a>创建View</h5><p>示例创建了大小两个版本的文件，</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">FrameLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/container"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></div><div class="line">        <span class="attr">android:padding</span>=<span class="string">"16dp"</span>&gt;</div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">ImageButton</span></span></div><div class="line">            <span class="attr">android:id</span>=<span class="string">"@+id/thumb_button_1"</span></div><div class="line">            <span class="attr">android:layout_width</span>=<span class="string">"100dp"</span></div><div class="line">            <span class="attr">android:layout_height</span>=<span class="string">"75dp"</span></div><div class="line">            <span class="attr">android:layout_marginRight</span>=<span class="string">"1dp"</span></div><div class="line">            <span class="attr">android:src</span>=<span class="string">"@drawable/thumb1"</span></div><div class="line">            <span class="attr">android:scaleType</span>=<span class="string">"centerCrop"</span></div><div class="line">            <span class="attr">android:contentDescription</span>=<span class="string">"@string/description_image_1"</span> /&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- This initially-hidden ImageView will hold the expanded/zoomed version of</span></div><div class="line">         the images above. Without transformations applied, it takes up the entire</div><div class="line">         screen. To achieve the "zoom" animation, this view's bounds are animated</div><div class="line">         from the bounds of the thumbnail button above, to its final laid-out</div><div class="line">         bounds.</div><div class="line">         --&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/expanded_image"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">        <span class="attr">android:visibility</span>=<span class="string">"invisible"</span></div><div class="line">        <span class="attr">android:contentDescription</span>=<span class="string">"@string/description_zoom_touch_close"</span> /&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><h5 id="设置缩放动画"><a href="#设置缩放动画" class="headerlink" title="设置缩放动画"></a>设置缩放动画</h5><p>监听点击事件，实现缩放效果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZoomActivity</span> <span class="keyword">extends</span> <span class="title">FragmentActivity</span> </span>&#123;</div><div class="line">    <span class="comment">// Hold a reference to the current animator,</span></div><div class="line">    <span class="comment">// so that it can be canceled mid-way.</span></div><div class="line">    <span class="keyword">private</span> Animator mCurrentAnimator;</div><div class="line"></div><div class="line">    <span class="comment">// The system "short" animation time duration, in milliseconds. This</span></div><div class="line">    <span class="comment">// duration is ideal for subtle animations or animations that occur</span></div><div class="line">    <span class="comment">// very frequently.</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mShortAnimationDuration;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_zoom);</div><div class="line"></div><div class="line">        <span class="comment">// Hook up clicks on the thumbnail views.</span></div><div class="line"></div><div class="line">        <span class="keyword">final</span> View thumb1View = findViewById(R.id.thumb_button_1);</div><div class="line">        thumb1View.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">                zoomImageFromThumb(thumb1View, R.drawable.image1);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        <span class="comment">// Retrieve and cache the system's default "short" animation time.</span></div><div class="line">        mShortAnimationDuration = getResources().getInteger(</div><div class="line">                android.R.integer.config_shortAnimTime);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><h5 id="缩放View"><a href="#缩放View" class="headerlink" title="缩放View"></a>缩放View</h5><p>缩放View的效果实现：</p>
</li>
</ul>
<ol>
<li>高清大图放在IamgeView中，用于放大后再显示。</li>
<li>计算image View的边界。</li>
<li>要同步改变四个边界，用<code>AnimatorSet</code></li>
<li>缩小则是类似逆向如上操作。注意view的属性需要设置gone。<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">zoomImageFromThumb</span><span class="params">(<span class="keyword">final</span> View thumbView, <span class="keyword">int</span> imageResId)</span> </span>&#123;</div><div class="line">    <span class="comment">// If there's an animation in progress, cancel it</span></div><div class="line">    <span class="comment">// immediately and proceed with this one.</span></div><div class="line">    <span class="keyword">if</span> (mCurrentAnimator != <span class="keyword">null</span>) &#123;</div><div class="line">        mCurrentAnimator.cancel();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Load the high-resolution "zoomed-in" image.</span></div><div class="line">    <span class="keyword">final</span> ImageView expandedImageView = (ImageView) findViewById(</div><div class="line">            R.id.expanded_image);</div><div class="line">    expandedImageView.setImageResource(imageResId);</div><div class="line"></div><div class="line">    <span class="comment">// Calculate the starting and ending bounds for the zoomed-in image.</span></div><div class="line">    <span class="comment">// This step involves lots of math. Yay, math.</span></div><div class="line">    <span class="keyword">final</span> Rect startBounds = <span class="keyword">new</span> Rect();</div><div class="line">    <span class="keyword">final</span> Rect finalBounds = <span class="keyword">new</span> Rect();</div><div class="line">    <span class="keyword">final</span> Point globalOffset = <span class="keyword">new</span> Point();</div><div class="line"></div><div class="line">    <span class="comment">// The start bounds are the global visible rectangle of the thumbnail,</span></div><div class="line">    <span class="comment">// and the final bounds are the global visible rectangle of the container</span></div><div class="line">    <span class="comment">// view. Also set the container view's offset as the origin for the</span></div><div class="line">    <span class="comment">// bounds, since that's the origin for the positioning animation</span></div><div class="line">    <span class="comment">// properties (X, Y).</span></div><div class="line">    thumbView.getGlobalVisibleRect(startBounds);</div><div class="line">    findViewById(R.id.container)</div><div class="line">            .getGlobalVisibleRect(finalBounds, globalOffset);</div><div class="line">    startBounds.offset(-globalOffset.x, -globalOffset.y);</div><div class="line">    finalBounds.offset(-globalOffset.x, -globalOffset.y);</div><div class="line"></div><div class="line">    <span class="comment">// Adjust the start bounds to be the same aspect ratio as the final</span></div><div class="line">    <span class="comment">// bounds using the "center crop" technique. This prevents undesirable</span></div><div class="line">    <span class="comment">// stretching during the animation. Also calculate the start scaling</span></div><div class="line">    <span class="comment">// factor (the end scaling factor is always 1.0).</span></div><div class="line">    <span class="keyword">float</span> startScale;</div><div class="line">    <span class="keyword">if</span> ((<span class="keyword">float</span>) finalBounds.width() / finalBounds.height()</div><div class="line">            &gt; (<span class="keyword">float</span>) startBounds.width() / startBounds.height()) &#123;</div><div class="line">        <span class="comment">// Extend start bounds horizontally</span></div><div class="line">        startScale = (<span class="keyword">float</span>) startBounds.height() / finalBounds.height();</div><div class="line">        <span class="keyword">float</span> startWidth = startScale * finalBounds.width();</div><div class="line">        <span class="keyword">float</span> deltaWidth = (startWidth - startBounds.width()) / <span class="number">2</span>;</div><div class="line">        startBounds.left -= deltaWidth;</div><div class="line">        startBounds.right += deltaWidth;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// Extend start bounds vertically</span></div><div class="line">        startScale = (<span class="keyword">float</span>) startBounds.width() / finalBounds.width();</div><div class="line">        <span class="keyword">float</span> startHeight = startScale * finalBounds.height();</div><div class="line">        <span class="keyword">float</span> deltaHeight = (startHeight - startBounds.height()) / <span class="number">2</span>;</div><div class="line">        startBounds.top -= deltaHeight;</div><div class="line">        startBounds.bottom += deltaHeight;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Hide the thumbnail and show the zoomed-in view. When the animation</span></div><div class="line">    <span class="comment">// begins, it will position the zoomed-in view in the place of the</span></div><div class="line">    <span class="comment">// thumbnail.</span></div><div class="line">    thumbView.setAlpha(<span class="number">0f</span>);</div><div class="line">    expandedImageView.setVisibility(View.VISIBLE);</div><div class="line"></div><div class="line">    <span class="comment">// Set the pivot point for SCALE_X and SCALE_Y transformations</span></div><div class="line">    <span class="comment">// to the top-left corner of the zoomed-in view (the default</span></div><div class="line">    <span class="comment">// is the center of the view).</span></div><div class="line">    expandedImageView.setPivotX(<span class="number">0f</span>);</div><div class="line">    expandedImageView.setPivotY(<span class="number">0f</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Construct and run the parallel animation of the four translation and</span></div><div class="line">    <span class="comment">// scale properties (X, Y, SCALE_X, and SCALE_Y).</span></div><div class="line">    AnimatorSet set = <span class="keyword">new</span> AnimatorSet();</div><div class="line">    set</div><div class="line">            .play(ObjectAnimator.ofFloat(expandedImageView, View.X,</div><div class="line">                    startBounds.left, finalBounds.left))</div><div class="line">            .with(ObjectAnimator.ofFloat(expandedImageView, View.Y,</div><div class="line">                    startBounds.top, finalBounds.top))</div><div class="line">            .with(ObjectAnimator.ofFloat(expandedImageView, View.SCALE_X,</div><div class="line">            startScale, <span class="number">1f</span>)).with(ObjectAnimator.ofFloat(expandedImageView,</div><div class="line">                    View.SCALE_Y, startScale, <span class="number">1f</span>));</div><div class="line">    set.setDuration(mShortAnimationDuration);</div><div class="line">    set.setInterpolator(<span class="keyword">new</span> DecelerateInterpolator());</div><div class="line">    set.addListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">            mCurrentAnimator = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationCancel</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">            mCurrentAnimator = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    set.start();</div><div class="line">    mCurrentAnimator = set;</div><div class="line"></div><div class="line">    <span class="comment">// Upon clicking the zoomed-in image, it should zoom back down</span></div><div class="line">    <span class="comment">// to the original bounds and show the thumbnail instead of</span></div><div class="line">    <span class="comment">// the expanded image.</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">float</span> startScaleFinal = startScale;</div><div class="line">    expandedImageView.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (mCurrentAnimator != <span class="keyword">null</span>) &#123;</div><div class="line">                mCurrentAnimator.cancel();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Animate the four positioning/sizing properties in parallel,</span></div><div class="line">            <span class="comment">// back to their original values.</span></div><div class="line">            AnimatorSet set = <span class="keyword">new</span> AnimatorSet();</div><div class="line">            set.play(ObjectAnimator</div><div class="line">                        .ofFloat(expandedImageView, View.X, startBounds.left))</div><div class="line">                        .with(ObjectAnimator</div><div class="line">                                .ofFloat(expandedImageView,</div><div class="line">                                        View.Y,startBounds.top))</div><div class="line">                        .with(ObjectAnimator</div><div class="line">                                .ofFloat(expandedImageView,</div><div class="line">                                        View.SCALE_X, startScaleFinal))</div><div class="line">                        .with(ObjectAnimator</div><div class="line">                                .ofFloat(expandedImageView,</div><div class="line">                                        View.SCALE_Y, startScaleFinal));</div><div class="line">            set.setDuration(mShortAnimationDuration);</div><div class="line">            set.setInterpolator(<span class="keyword">new</span> DecelerateInterpolator());</div><div class="line">            set.addListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">                    thumbView.setAlpha(<span class="number">1f</span>);</div><div class="line">                    expandedImageView.setVisibility(View.GONE);</div><div class="line">                    mCurrentAnimator = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationCancel</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">                    thumbView.setAlpha(<span class="number">1f</span>);</div><div class="line">                    expandedImageView.setVisibility(View.GONE);</div><div class="line">                    mCurrentAnimator = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            set.start();</div><div class="line">            mCurrentAnimator = set;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="5、布局动画"><a href="#5、布局动画" class="headerlink" title="5、布局动画"></a>5、布局动画</h4><p>布局动画是一种预加载动画，可以通过创建Layout Transition ，setLayoutTransition（）实现。<br><a href="http://hukai.me/android-training-course-in-chinese/animations/anim_layout_changes.mp4" target="_blank" rel="external">layout</a></p>
<ul>
<li><h5 id="创建布局"><a href="#创建布局" class="headerlink" title="创建布局"></a>创建布局</h5><p>为想开启动画的布局设置<code>android:animateLayoutChanges</code>属性为<code>true</code>。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">android:id</span>=<span class="string">"@+id/container"</span></span></div><div class="line">    <span class="attr">android:animateLayoutChanges</span>=<span class="string">"true"</span></div><div class="line">    <span class="attr">...</span></div><div class="line">/&gt;</div></pre></td></tr></table></figure>
</li>
<li><h5 id="从布局中增删项目"><a href="#从布局中增删项目" class="headerlink" title="从布局中增删项目"></a>从布局中增删项目</h5><p>代码中动态修改布局项目，实现动画</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ViewGroup mContainerView;</div><div class="line">...</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addItem</span><span class="params">()</span> </span>&#123;</div><div class="line">    View newView;</div><div class="line">    ...</div><div class="line">    mContainerView.addView(newView, <span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li>
</ul>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2017/03/28/hello-world/" data-toggle="tooltip" data-placement="top" title="Hello World">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2017/03/27/第三篇、Android多媒体/" data-toggle="tooltip" data-placement="top" title="Android多媒体">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                

            </div>
    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Android" title="Android">Android</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="http://blog.csdn.net/binglumeng" target="_blank">Binglumeng&#39;s Blog</a></li>
                    
                        <li><a href="http://blog.csdn.net/binglumeng" target="_blank">冰路梦</a></li>
                    
                        <li><a href="https://binglumeng.github.io" target="_blank">Github</a></li>
                    
                        <li><a href="https://binglumeng.github.io" target="_blank">Github</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>







<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                    <li>
                        <a target="_blank" href="https://twitter.com/冰路梦">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/冰路梦">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/冰路梦">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="https://www.facebook.com/冰路梦">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank"  href="https://github.com/binglumeng">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank"  href="https://www.linkedin.com/in/冰路梦">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; 冰路梦Github空间 2017 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    Ported by <a href="http://blog.csdn.net/binglumeng">binglumeng</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=binglumeng&repo=binglumeng.github.io&type=star&count=true" >
                    </iframe>
					<br>
					本站总访问量 <span id="busuanzi_value_site_pv"></span> 次, 访客数 <span id="busuanzi_value_site_uv"></span> 人次, 本文总阅读量 <span id="busuanzi_value_page_pv"></span> 次
					
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://binglumeng.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>

<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<!-- Image to hack wechat -->
<img src="https://binglumeng.github.io/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->
</body>

</html>
